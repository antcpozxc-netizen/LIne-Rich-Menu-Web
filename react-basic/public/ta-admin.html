<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="/__boot/liff-id.js"></script>
<style>
  :root{
    --pri:#3b82f6; --pri-600:#2563eb; --pri-700:#1d4ed8;
    --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff; --ring:#c7d2fe;
    --ok:#16a34a; --err:#dc2626;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  .hero{background:linear-gradient(135deg,var(--pri) 0%, var(--pri-700) 70%);color:#fff;padding:22px 20px 64px}
  .wrap{max-width:1120px;margin:-42px auto 32px;padding:0 16px}
  .card{background:var(--card);border-radius:20px;box-shadow:0 12px 30px rgba(2,6,23,.08);padding:18px;margin-bottom:16px;border:1px solid #eef2ff}
  h1,h2,h3{margin:0 0 10px}
  .muted{color:var(--muted);font-size:13px}
  .err{color:var(--err)} .ok{color:var(--ok)}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--pri);color:#fff;cursor:pointer;box-shadow:0 6px 16px rgba(37,99,235,.25)}
  .btn:hover{background:var(--pri-600)}
  .btn-ghost{background:#fff;color:var(--pri);border:1px solid var(--ring)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
  label{font-size:12px;color:#334155;display:block;margin-bottom:6px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  .tile{display:flex;flex-direction:column;gap:8px;align-items:flex-start;padding:16px;border:1px dashed #e2e8f0;border-radius:16px;background:#fbfdff;text-decoration:none;color:inherit}
  .tile:hover{box-shadow:0 6px 20px rgba(2,6,23,.06)}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .back{color:#e2e8f0;text-decoration:none}
  .hidden{display:none!important}

  /* Employee list */
  .cards-h{display:flex; gap:12px; overflow-x:auto; padding-bottom:6px; scroll-snap-type:x proximity}
  .cards-h::-webkit-scrollbar{height:8px}
  .cards-h::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:999px}
  .emp{min-width:260px; scroll-snap-align:start; border:1px solid #edf2ff;border-radius:18px;padding:14px;background:#fff;box-shadow:0 6px 18px rgba(2,6,23,.05)}
  .emp:hover{box-shadow:0 10px 24px rgba(2,6,23,.08)}
  .emp .top{display:flex;gap:10px;align-items:center}
  .avatar{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#eff6ff,#dbeafe);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--pri-700)}
  .chip{display:inline-block;font-size:12px;border-radius:999px;padding:4px 10px;background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe}
  .kv{display:grid;grid-template-columns:112px 1fr;gap:4px;font-size:13px;color:#334155;margin-top:8px}
  .kv b{color:#64748b;font-weight:500}

  /* Tables */
  .table-wrap{overflow:auto;border:1px solid #e9eefc;border-radius:12px;background:#fff}
  table.log{border-collapse:separate;border-spacing:0;width:100%}
  table.log th, table.log td{padding:10px 12px;font-size:13px;border-bottom:1px solid #eef2ff;white-space:nowrap;vertical-align:top}
  table.log th{position:sticky;top:0;background:#f8fafc;font-weight:700;color:#334155;z-index:1}
  table.log tr:last-child td{border-bottom:none}
  .sum{background:#f8fafc;border:1px dashed #e2e8f0;border-radius:12px;padding:12px;margin-top:8px}
  .seg{display:flex;gap:6px;flex-wrap:wrap}
  .seg button{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#fff;color:#1e293b;cursor:pointer}
  .seg button.on{background:var(--pri);color:#fff;border-color:transparent}

  /* payroll tabs */
  .seg-btn{padding:8px 14px;border-radius:999px;border:1px solid var(--ring);background:#fff;cursor:pointer}
  .seg-btn.on{background:var(--pri);color:#fff;border-color:transparent}
  #pr-table th, #pr-table td { white-space:nowrap; }
  #pr-table tfoot td{font-weight:700;background:#f8fafc}
  .status-col{min-width:180px}
  .status-col .pr-status{min-width:140px;width:100%}

  /* reports KPI */
  .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
  .kpi .box{background:#fbfdff;border:1px dashed #e2e8f0;border-radius:12px;padding:12px}
  .kpi .box .lbl{font-size:12px;color:#64748b}
  .kpi .box .val{font-size:20px;font-weight:700}

  /* modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.hidden{display:none!important}
  .modal .backdrop{position:absolute;inset:0;background:rgba(15,23,42,.45)}
  .modal .panel{position:relative;max-width:980px;width:100%;max-height:90vh;overflow:auto;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(2,6,23,.25);border:1px solid #eef2ff}
  .modal .hd{padding:14px 16px;border-bottom:1px solid #eef2ff;display:flex;justify-content:space-between;align-items:center}
  .modal .bd{padding:14px 16px}
  .modal .close{appearance:none;border:0;background:#fff;border:1px solid var(--ring);border-radius:10px;padding:6px 10px;cursor:pointer}
  .run-kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:10px 0}
  .run-kpi .box .lbl{font-size:12px;color:#64748b}
  .run-kpi .box .val{font-size:18px;font-weight:700}

    /* ========= Payment modal ‚Äì layout ========= */
  .modal .panel.pay-panel{
    max-width:520px;
    width:100%;
    border-radius:24px;
    overflow:hidden;
  }

  .pay-header{
    padding:14px 18px;
  }
  .pay-header-main{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .pay-header-title{
    font-size:17px;
    font-weight:700;
  }
  .pay-header-sub{
    font-size:13px;
    color:var(--muted);
  }

  .pay-header .close{
    border-radius:999px;
    padding:6px 12px;
    font-size:13px;
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ */
  #pay-summary{
    margin-top:0;
    border-radius:18px;
    padding:14px 16px;
    background:#eff6ff;
    border:1px solid #dbeafe;
  }
  #pay-summary .pay-summary-name{
    font-weight:600;
    margin-bottom:2px;
  }
  #pay-summary .pay-summary-label{
    font-size:13px;
    color:#64748b;
    margin-top:4px;
  }
  #pay-summary .pay-summary-amount{
    font-size:20px;
    font-weight:800;
    margin-left:4px;
  }

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î */
  #pay-bank-box{
    margin-top:12px;
    padding:14px 16px;
    border-radius:18px;
    background:#f8fafc;
    border:1px dashed #e2e8f0;
  }
  .pay-bank-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
  }
  #pay-bank-line{
    font-size:13px;
    line-height:1.5;
  }
  .pay-bank-actions{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:8px;
  }
  .pay-bank-helper{
    font-size:12px;
    color:#64748b;
    margin:10px 0 6px;
  }
  #pay-bank-apps{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .bank-app-btn img{
    box-shadow:0 4px 12px rgba(15,23,42,.16);
  }

  #pay-cash-box{
    margin-top:12px;
    border-radius:18px;
    font-size:14px;
  }

  /* footer ‡∏õ‡∏∏‡πà‡∏° */
  .pay-footer{
    margin-top:14px;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:8px;
  }
  #pay-confirm{
    flex:1;
  }

  #pay-msg{
    font-size:12px;
    color:var(--muted);
  }


  /* preloader/skeleton */
  #app-preload{position:fixed;inset:0;background:rgba(248,250,252,.85);backdrop-filter:saturate(160%) blur(2px);display:flex;align-items:center;justify-content:center;z-index:70}
  #app-preload .box{background:#fff;border:1px solid #eef2ff;border-radius:16px;padding:16px 18px;box-shadow:0 20px 60px rgba(2,6,23,.1)}
  .loader{width:24px;height:24px;border-radius:50%;border:3px solid #c7d2fe;border-top-color:#3b82f6;animation:spin 1s linear infinite;margin-right:10px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <header class="hero">
    <div class="toolbar" style="max-width:1120px;margin:0 auto">
      <div>
        <div style="display:flex;align-items:center;gap:10px">
          <img alt="" src="data:image/svg+xml,%3Csvg width='28' height='28' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='14' cy='14' r='12' fill='%23ffffff'/%3E%3C/svg%3E" />
          <h2 style="margin:0">HR MANAGEMENT</h2>
        </div>
        <div class="muted" style="color:#e0e7ff">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ & ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>
      <a id="btnHome" class="back hidden" href="#">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π</a>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="toolbar">
        <h3 id="title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</h3>
        <span id="status" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</span>
      </div>
    </div>

    <!-- MENU -->
    <section id="view-menu" class="card hidden">
      <h3>‡πÄ‡∏°‡∏ô‡∏π</h3>
      <div class="grid">
        <a class="tile" href="#users">
          <h3>1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
          <div class="muted">‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó + ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
        </a>
        <a class="tile" href="#logs">
          <h3>2) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
          <div class="muted">‡∏î‡∏π‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô + ‡∏•‡∏≤ + ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
        </a>
        <a class="tile" href="#payroll">
          <h3>3) ‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
          <div class="muted">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì/‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‚Äù</div>
        </a>
        <a class="tile" href="#reports">
          <h3>4) ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
          <div class="muted">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏ß‡∏î (runs) ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        </a>
      </div>
    </section>

    <!-- USERS -->
    <section id="view-users" class="hidden">
      <div class="card">
        <div class="toolbar">
          <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
          <div class="row" style="align-items:end">
            <div class="col"><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label><input id="q" placeholder="‡∏ä‡∏∑‡πà‡∏≠/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"/></div>
            <div style="display:flex;gap:8px">
              <button id="reload" class="btn">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
              <button id="users-refresh" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
          </div>
        </div>
        <div id="lazyNote" class="muted" style="margin:8px 0">‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
        <div id="cards" class="cards-h" style="margin-top:4px"></div>
      </div>

      <!-- Editor -->
      <div class="card hidden" id="editor">
        <h3 id="empTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>

        <div class="row">
          <div class="col"><label>LINE User ID</label><input id="lineUserId" readonly></div>
          <div class="col"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input id="fullName"></div>
          <div class="col"><label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input id="nationalId"></div>
        </div>

        <div class="row">
          <div class="col"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="phone"></div>
          <div class="col"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input id="birthDate" type="date"></div>
          <div class="col"><label>‡πÄ‡∏û‡∏®</label><input id="gender" placeholder="male/female/other"></div>
        </div>

        <div class="row">
          <div class="col"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£</label><input id="idAddress"></div>
          <div class="col"><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label><input id="currentAddress"></div>
        </div>

        <div class="row">
          <div class="col"><label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (jobTitle)</label><input id="jobTitle"></div>
          <div class="col"><label>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (role)</label>
            <select id="role"><option>user</option><option>admin</option><option>owner</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label>
            <input id="registerDate" type="date">
          </div>
        </div>

        <!-- üî∏ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
        <h4 style="margin:14px 0 6px">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>

        <div class="row">
          <div class="col">
            <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢</label>
            <select id="payoutChannel">
              <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
              <option value="bank">‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
            </select>
          </div>
        </div>

        <div class="row" id="bankWrap">
          <div class="col">
            <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
            <input id="bankName" placeholder="‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">
          </div>
          <div class="col">
            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <input id="bankAccount" placeholder="2222222222">
          </div>
        </div>

        <!-- ‚úÖ ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á ‡πÅ‡∏¢‡∏Å "‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢" ‡πÅ‡∏•‡∏∞ "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πâ‡∏≤‡∏á" -->
        <h4 style="margin:14px 0 6px">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</h4>

        <div class="row" style="margin-bottom:8px">
          <div class="col">
            <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≠‡∏ö / ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</label>
            <select id="payCycleType">
              <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
              <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
              <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="every_n_days">‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô</option>
            </select>
          </div>
          <div class="col" id="wrapPayCycleN">
            <label>N (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô)</label>
            <input id="payCycleN" type="number" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5 = ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏±‡∏ô">
          </div>
        </div>

        <h4 style="margin:10px 0 6px">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</h4>
        
        <div class="row">
          <div class="col"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πâ‡∏≤‡∏á</label>
            <select id="payType">
              <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
              <option value="hourly">‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
              <option value="every_n_days">‡∏ó‡∏∏‡∏Å N ‡∏ß‡∏±‡∏ô</option>
              <option value="every_n_hours">‡∏ó‡∏∏‡∏Å N ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
            </select>
          </div>
          <div class="col"><label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô)</label><input id="payRate" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15000 / 400 / 60"></div>
          <div class="col"><label>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡∏ß‡∏±‡∏ô (‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≤‡∏¢)</label><input id="dailyHours" type="number" step="0.5" value="8"></div>
          <div class="col"><label>‡∏´‡∏±‡∏Å‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</label>
            <select id="prorateLate"><option value="true">‡∏´‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î</option><option value="false">‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å</option></select>
          </div>
          <div class="col" id="wrapPayEveryN"><label>Pay every N</label><input id="payEveryN" type="number" step="1" placeholder="‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î every_n_* ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"></div>
        </div>

        <div class="row">
          <div class="col"><label>‡πÄ‡∏Ç‡πâ‡∏≤ (HH:MM)</label><input id="shiftIn" placeholder="09:00"></div>
          <div class="col"><label>‡∏≠‡∏≠‡∏Å (HH:MM)</label><input id="shiftOut" placeholder="18:00"></div>
          <div class="col"><label>‡∏ú‡πà‡∏≠‡∏ô‡∏ú‡∏±‡∏ô‡∏™‡∏≤‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</label><input id="lateGraceMin" type="number" step="1" value="0"></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
            <div id="emp-groups"
                 style="max-height:140px;overflow:auto;border:1px dashed #e2e8f0;border-radius:10px;
                        padding:6px;font-size:13px">
              <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‚Ä¶</div>
            </div>
            <div class="muted" style="margin-top:4px">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            </div>
          </div>
          <div class="col">
            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
            <input id="breakMinutes" type="number" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 60">
          </div>
          <div class="col">
            <label>‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (‡∏ß‡∏±‡∏ô)</label>
            <input id="leaveQuotaDays" type="number" step="0.5" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="save" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          <button id="remove" class="btn-ghost" style="margin-left:8px">‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
          <span class="muted" id="saveMsg" style="margin-left:10px"></span>
        </div>

      </div>
    </section>

    <!-- LOGS -->
    <section id="view-logs" class="hidden">
      <div class="card">
        <div class="toolbar">
          <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô & ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
          <div class="row" style="align-items:flex-end">
            <div class="col"><label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input id="month" type="month"></div>
            <div class="col"><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label><input id="q2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠"></div>
            <div style="flex:0 0 auto"><button id="logs-refresh" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>
          </div>
        </div>
        <div id="lazyNote2" class="muted" style="margin:8px 0">‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Ä¶</div>
        <div id="cards2" class="cards-h" style="margin-top:4px"></div>
      </div>

      <div class="card hidden" id="panelLogs">
        <div class="toolbar">
          <h3 id="logTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
          <span id="logStatus" class="muted"></span>
        </div>

        <div class="sum" id="summaryBox" style="margin:8px 0 12px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
        <div class="table-wrap"><table class="log">
          <thead>
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡πÄ‡∏Ç‡πâ‡∏≤</th>
              <th>‡∏≠‡∏≠‡∏Å</th>
              <th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
              <th>‡∏™‡∏≤‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏•‡∏≤</th>
            </tr>
          </thead>
          <tbody id="logTbody"></tbody>
        </table></div>
      </div>
    </section>

    <!-- PAYROLL -->
    <section id="view-payroll" class="hidden">
      <div class="card">
        <div class="toolbar">
          <h3>‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
        </div>
        
         <!-- ‚úÖ Top toolbar: Global refresh -->
        <div class="toolbar" id="payroll-topbar" style="margin:6px 0 8px">
          <button id="pr-global-refresh" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <span class="muted">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏ó‡πá‡∏ö</span>
        </div>

        <!-- Tabs -->
        <div style="display:flex;gap:8px;margin:8px 0">
          <button id="tab-payrun"  class="seg-btn on">1) ‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
          <button id="tab-cycles"  class="seg-btn">2) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
          <button id="tab-payments" class="seg-btn">3) ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
        </div>

        <!-- DUE TODAY: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
        <div class="sum" id="pr-due" style="margin-top:8px">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <b style="margin-right:6px">Due Today</b>
            <input id="dueTodayInput" type="date" />
            <button id="btnLoadDue" class="btn-ghost">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button id="btnNotifyToday" class="btn">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <span class="muted" id="dueStat"></span>
          </div>
          <div id="dueList" style="margin-top:8px"></div>
        </div>

        <!-- TAB 1: ‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
        <div id="pane-payrun">
          <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î -->
          <div class="sum" id="pr-groups-overview" style="margin-top:0">
            <b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</b>
            <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
            <div class="table-wrap" style="margin-top:6px">
              <table class="log" id="pr-groups-table">
                <thead>
                  <tr>
                    <th>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                    <th>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô/‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢</th>
                    <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</th>
                  </tr>
                </thead>
                <tbody id="pr-groups-tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì -->
          <div class="row" style="align-items:flex-end;margin-top:10px">
          <div class="col">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</label>
            <select id="pr-group"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î ‚Äî</option></select>
          </div>
          <div class="col">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</label>
            <label style="margin-top:4px;display:block">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="pr-start" type="date">
          </div>
          <div class="col">
            <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="pr-end" type="date">
          </div>

          <!-- üîª ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠ (‡∏¢‡∏±‡∏á‡∏õ‡∏•‡πà‡∏≠‡∏¢ element ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ô script error) -->
          <div class="col" style="display:none">
            <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
            <input id="pr-q" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
          </div>

          <div class="col" style="flex:0 0 auto">
            <button id="pr-draft" class="btn">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
          </div>
        </div>


          <div class="sum" id="pr-status" style="margin-top:10px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Äù</div>

          <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏¥‡∏° + ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î -->
          <div class="sum hidden" id="pr-run-box" style="margin-top:8px">
            <b>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î:</b> <span id="pr-runid-chip" class="chip">‚Äî</span>
            <div id="pr-run-members" style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap"></div>
          </div>

          <!-- Preview ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° -->
          <div class="sum hidden" id="pr-members-box" style="margin-top:8px">
            <b>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°:</b> <span id="pr-members-count">0</span> ‡∏Ñ‡∏ô
            <div id="pr-members-list" style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap"></div>
          </div>

          <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ -->
          <div class="table-wrap" style="margin-top:10px">
            <table class="log" id="pr-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="pr-checkall"></th>
                  <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                  <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                  <th>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢</th>
                  <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                  <th>‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                  <th>‡∏ä‡∏°.‡∏™‡∏≤‡∏¢</th>
                  <th>‡∏ä‡∏°.‡∏•‡∏≤</th>
                  <th>‡∏ê‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢</th>
                  <th>‡∏´‡∏±‡∏Å/‡∏õ‡∏£‡∏±‡∏ö (-)</th>
                  <th>‡∏ö‡∏ß‡∏Å‡∏õ‡∏£‡∏±‡∏ö (+)</th>
                  <th>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                  <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                  <th class="status-col">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
              </thead>
              <tbody id="pr-body"></tbody>
              <tfoot>
                <tr>
                  <td colspan="12" style="text-align:right">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td>
                  <td id="pr-total" style="font-weight:700">0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="row" style="margin-top:12px">
            <button id="pr-commit-selected" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</button>
            <button id="pr-refresh" class="btn-ghost">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà</button>
            <button id="pr-hard-reload" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <span class="muted" id="pr-msg"></span>
          </div>
        </div>

        <!-- TAB 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î) -->
        <div id="pane-cycles" class="hidden">
          <div class="toolbar">
            <div>
              <h3 style="margin:0">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
              <div class="muted">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ¬∑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ¬∑ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div>
            </div>
            <button id="pg-create" class="btn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
          </div>

          <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
          <div class="table-wrap" style="margin-top:10px">
            <table class="log" id="pg-groups-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                  <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="pg-groups-body"></tbody>
            </table>
          </div>

          <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏° -->
          <div class="card hidden" id="pg-editor" style="margin-top:12px">
            <div class="toolbar">
              <h3 id="pg-edit-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°</h3>
              <div>
                <button id="pg-save" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button id="pg-cancel" class="btn-ghost" style="margin-left:8px">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              </div>
            </div>

            <div class="row" style="margin-top:6px">
              <div class="col"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°</label><input id="pg-name"></div>
              <div class="col">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="pg-type">
                  <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                  <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                  <option value="every_n_days">‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô</option>
                </select>
              </div>
              <div class="col" id="pg-payday-wrap">
                <label>‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢ (1‚Äì31 ‡∏´‡∏£‡∏∑‡∏≠ last)</label>
                <input id="pg-payday" placeholder="last">
              </div>
              <div class="col"><label>N (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å N ‡∏ß‡∏±‡∏ô)</label><input id="pg-n" type="number" min="1" step="1"></div>
              <div class="col"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì / ‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô</label><input id="pg-start" type="date"></div>
            </div>

            <div class="sum" style="margin-top:8px"><b>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</b> <span class="muted">(‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å)</span></div>
            <div class="row" style="align-items:flex-end;margin-top:8px">
              <div class="col"><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input id="pg-member-q" placeholder="‡∏ä‡∏∑‡πà‡∏≠/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"></div>
            </div>
            <div class="table-wrap" style="margin-top:6px">
              <table class="log">
                <thead>
                  <tr>
                    <th>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                    <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢ (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</th>
                  </tr>
                </thead>
                <tbody id="pg-members"></tbody>
              </table>
            </div>

            <div class="row" style="margin-top:10px">
              <span class="muted" id="pg-msg"></span>
            </div>
          </div>
        </div>
        
        <!-- TAB 3: ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
        <div id="pane-payments" class="hidden">
          <div class="sum" style="margin-top:0">
            <b>‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° Pay Run</b>
            <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î (run) ‚Üí ‡∏Å‡∏î ‚Äú‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‚Äù ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô</div>
            <div class="row" style="align-items:flex-end;margin-top:6px">
            <div class="col"><label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input id="py-month" type="month"></div>
            <div class="col">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pay Run</label>
                <select id="py-run"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pay Run ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Äî</option></select>
            </div>
            <div style="flex:0 0 auto"><button id="py-refresh" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>
            </div>
          </div>

          <div class="grid" style="margin-top:10px">
            <div class="card">
              <div class="toolbar"><h3 style="margin:0">‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ (Approved)</h3></div>
              <div class="table-wrap" style="margin-top:8px">
                <table class="log" id="py-approved-table">
                <thead>
                    <tr>
                    <th>#</th>
                    <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="py-approved-body"></tbody>
                </table>
              </div>
            </div>

            <div class="card">
            <div class="toolbar"><h3 style="margin:0">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Paid)</h3></div>
            <div class="table-wrap" style="margin-top:8px">
                <table class="log" id="py-paid-table">
                <thead>
                    <tr>
                    <th>#</th>
                    <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                    <th>‡∏î‡∏π‡∏á‡∏ß‡∏î</th>
                    </tr>
                </thead>
                <tbody id="py-paid-body"></tbody>
                </table>
            </div>
            </div>
          </div>

          <div class="sum" id="py-msg" style="margin-top:10px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏á‡∏ß‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡πà‡∏≤‡∏¢</div>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="view-reports" class="hidden">
      <div class="card">
        <div class="toolbar">
          <h3>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
          <div class="row" style="align-items:flex-end">
            <div class="col"><label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input id="rp-month" type="month"></div>
            <div style="flex:0 0 auto"><button id="reports-refresh" class="btn-ghost">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>
          </div>
        </div>

        <div class="sum" id="rp-status">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ ‚Äú‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏ß‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>

        <div class="kpi">
          <div class="box"><div class="lbl">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</div><div class="val" id="rp-k1">-</div></div>
          <div class="box"><div class="lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div><div class="val" id="rp-k2">-</div></div>
        </div>

        <div class="table-wrap" style="margin-top:10px">
          <table class="log" id="rp-table">
            <thead>
              <tr>
                <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</th>
                <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                <th>‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                <th>‡∏ä‡∏°.‡∏™‡∏≤‡∏¢/‡∏•‡∏≤</th>
                <th>‡∏ê‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢</th>
                <th>‡∏´‡∏±‡∏Å‡∏™‡∏≤‡∏¢</th>
                <th>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
              </tr>
            </thead>
            <tbody id="rp-body"></tbody>
            <tfoot>
              <tr>
                <td colspan="9" style="text-align:right">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</td>
                <td id="rp-total" style="font-weight:700">0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="sum" style="margin-top:10px">
          <b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
          <div class="muted">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å pay run ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‚Äú‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ¬∑ ‡πÅ‡∏ï‡∏∞ run ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
        </div>

        <div class="table-wrap" style="margin-top:10px">
          <table class="log" id="runs-table">
            <thead>
              <tr>
                <th>runId</th>
                <th>‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
              </tr>
            </thead>
            <tbody id="runs-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="run-modal" class="modal hidden" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel">
      <div class="hd">
        <div>
          <div style="font-weight:700" id="run-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ß‡∏î</div>
          <div class="muted" id="run-subtitle"></div>
        </div>
        <button class="close" id="run-close">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="bd">
        <div class="run-kpi">
          <div class="box"><div class="lbl">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏£‡∏ß‡∏°</div><div class="val" id="run-k1">-</div></div>
          <div class="box"><div class="lbl">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div><div class="val" id="run-k2">-</div></div>
          <div class="box"><div class="lbl">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô</div><div class="val" id="run-k3">-</div></div>
        </div>
        <div class="table-wrap" style="margin-top:8px">
          <table class="log" id="run-table">
            <thead>
              <tr>
                <th>#</th>
                <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö/‡∏≠‡∏±‡∏ï‡∏£‡∏≤</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                <th>‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                <th>‡∏ä‡∏°.‡∏™‡∏≤‡∏¢/‡∏•‡∏≤</th>
                <th>‡∏ê‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢</th>
                <th>‡∏´‡∏±‡∏Å‡∏™‡∏≤‡∏¢</th>
                <th>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
              </tr>
            </thead>
            <tbody id="run-body"></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="run-edit-here">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô ‚Äú‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‚Äù</button>
          <span class="muted" id="run-msg"></span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ‚ñ∂‚ñ∂ Payment Modal: ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô ‚óÄ‚óÄ -->
  <div id="pay-modal" class="modal hidden" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="panel pay-panel">
      <div class="hd pay-header">
        <div class="pay-header-main">
          <div id="pay-title" class="pay-header-title">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <div id="pay-subtitle" class="pay-header-sub">-</div>
        </div>
        <button class="close" id="pay-close">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div class="bd">
        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ -->
        <div id="pay-summary">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>

        <!-- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ -->
        <div id="pay-bank-box" style="display:none">
          <div class="pay-bank-title">‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
          <div id="pay-bank-line" class="muted">-</div>

          <div class="pay-bank-actions">
            <button class="btn-ghost" id="pay-copy-account">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
            <span class="muted" id="pay-copy-msg"></span>
          </div>

          <div class="pay-bank-helper">
            ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
          </div>
          <div id="pay-bank-apps"></div>
        </div>

        <!-- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ -->
        <div id="pay-cash-box" class="sum" style="display:none">
          ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ: <b>‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</b>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å -->
        <div class="pay-footer">
          <button class="btn" id="pay-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
          <button class="btn-ghost" id="pay-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <span id="pay-msg"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Preloader -->
  <div id="app-preload" class="hidden" aria-hidden="true">
    <div class="box" style="display:flex;align-items:center;gap:10px">
      <div class="loader"></div>
      <div>
        <div style="font-weight:700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‚Ä¶</div>
        <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers: month key & status ---------- */
function pad2(n){ return String(n).padStart(2,'0'); }
function todayMonthKey(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function getMonthKey(v){
  const s=String(v||'').trim(); if(!s) return '';
  if (/^\d{4}-\d{2}$/.test(s)) return s;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s.slice(0,7);
  const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  return '';
}
const ALLOW_STATUS = ['pending','approved','paid','rejected'];
function normalizeStatus(v){ const s=String(v||'').toLowerCase().trim(); return ALLOW_STATUS.includes(s)? s : 'pending'; }

/* ---------- router ---------- */
function readParams(){
  const outer = new URLSearchParams(location.search);
  const merged = new URLSearchParams(outer);
  const st = outer.get('liff.state');
  if (st) { const inner = new URLSearchParams(st.startsWith('?')? st.slice(1) : st); for (const [k,v] of inner) merged.set(k,v); }
  return merged;
}
const qs = readParams();
const LIFF_ID = qs.get('liffId') || (window.DEFAULT_LIFF_ID || '');
const TENANT  = qs.get('tenant') || '';
const DEFAULT_VIEW = (qs.get('view') || '').toLowerCase();

const MODE_REPORT  = /^(1|true)$/i.test(qs.get('report') || '');
const MODE_PAYROLL = /^(1|true)$/i.test(qs.get('payroll') || '');
const FORCED_MONTH = qs.get('month') || '';

const $status  = document.getElementById('status');
const setMsg = (t,cls='muted') => { $status.className=cls; $status.textContent=t; };

let __editingRunId = null; // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏¥‡∏°
let __editRunMembers = null; // Set ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î

const $btnHome = document.getElementById('btnHome');
const sections = {
  menu:document.getElementById('view-menu'),
  users:document.getElementById('view-users'),
  logs:document.getElementById('view-logs'),
  payroll:document.getElementById('view-payroll'),
  reports:document.getElementById('view-reports')
};
function show(id){
  Object.entries(sections).forEach(([k,el])=> el.classList.toggle('hidden', k!==id));
  const mapTitle = {menu:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)', users:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', logs:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', payroll:'‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', reports:'‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'};
  document.getElementById('title').textContent = mapTitle[id] || '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)';
  $btnHome.classList.toggle('hidden', id==='menu');
}
function go(id){ location.hash = id; }
const INITIAL_VIEW = ((location.hash||'').slice(1) || DEFAULT_VIEW || 'menu').toLowerCase();
show(INITIAL_VIEW);
if (!location.hash && DEFAULT_VIEW) { location.replace('#' + DEFAULT_VIEW.toLowerCase()); }

/* ---------- LIFF + actor ---------- */
let ACTOR = null;
async function ensureLiff(){
  if (!LIFF_ID) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF ID');
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()){
    liff.login({ redirectUri: location.href });
    return false;
  }
  return true;
}
async function getActor(){
  if (ACTOR) return ACTOR;
  let uid=null; try { uid = liff.getDecodedIDToken()?.sub || null; } catch {}
  if (uid) uid = uid.replace('line:',''); if (!uid){ try { uid = (await liff.getProfile()).userId || null; } catch {} }
  if (!uid) throw new Error('‡∏≠‡πà‡∏≤‡∏ô LINE UserId ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); ACTOR = { lineUserId: uid }; return ACTOR;
}

/* ---------- auth bearer helper ---------- */
async function getBearer(){
  try{
    if (window.firebase?.auth?.currentUser){
      const t = await window.firebase.auth().currentUser.getIdToken(true);
      if (t) return 'Bearer ' + t;
    }
  }catch{}
  try{
    const lt = (typeof liff.getIDToken === 'function') ? liff.getIDToken() : '';
    if (lt) return 'Bearer ' + lt;
  }catch{}
  return '';
}

/* ---------- UTIL ---------- */
const initials = (name='')=>{ const t=String(name).trim().split(/\s+/).filter(Boolean); if(!t.length) return '??'; if(t.length===1) return t[0].slice(0,2).toUpperCase(); return (t[0][0]+t[t.length-1][0]).toUpperCase(); };
const money = v => (v==null||v==='') ? '-' : Number(v).toLocaleString();
const ymdLocal = (d) => { const dt = (d instanceof Date) ? d : new Date(d); if (isNaN(dt.getTime())) return ''; return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`; };
const onlyDate = (s) => {
  if (!s) return '';
  const str = String(s);
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  if (str.includes('T')) return ymdLocal(str);
  const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) { const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1])); return ymdLocal(d); }
  const d2 = new Date(str); return isNaN(d2.getTime()) ? '' : ymdLocal(d2);
};
function monthStr(d){ const dt = d ? new Date(d) : new Date(); return dt.toISOString().slice(0,7); }
function monthRangeStr(yyyyMM){
  const [Y,M] = String(yyyyMM || monthStr()).split('-').map(Number);
  const first = new Date(Y, (M||1)-1, 1);
  const last  = new Date(Y,  M||1, 0);
  const toYMD = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  return { first: toYMD(first), last: toYMD(last) };
}
function daysBetweenInclusive(a, b){
  const d1 = new Date(a);
  const d2 = new Date(b);
  if (isNaN(d1) || isNaN(d2)) return 30;
  const utc = (d)=> Date.UTC(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = Math.floor((utc(d2) - utc(d1)) / 86400000) + 1;
  return Math.max(1, diff);
}
function parseHm(hm){ const m=String(hm||'').match(/^(\d{1,2}):(\d{2})$/); if(!m) return null; const h=+m[1], mi=+m[2]; if(h<0||h>23||mi<0||mi>59) return null; return {h, m:mi}; }

// === pay-type display helpers ===
const safe = v => (v===undefined || v===null || v==='') ? '' : v;
const mapPayTypeTH = (t, n) => {
  switch (String(t||'').toLowerCase()) {
    case 'hourly': return '‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á';
    case 'daily': return '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
    case 'monthly': return '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
    case 'every_n_days': return `‡∏ó‡∏∏‡∏Å ${n||'?'} ‡∏ß‡∏±‡∏ô`;
    case 'every_n_hours': return `‡∏ó‡∏∏‡∏Å ${n||'?'} ‡∏ä‡∏°.`;
    default: return '';
  }
};
function displayPay(o){
  const employmentType = safe(o?.employmentType);
  if (employmentType) return employmentType;
  const t = o?.payType, n = o?.payEveryN;
  const label = mapPayTypeTH(t, n);
  return label || '‚Äî';
}

// ‡πÅ‡∏õ‡∏•‡∏á type ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢
function groupTypeLabel(g){
  const t = String(g.type || '').toLowerCase();
  const meta = g.meta || {};
  const n = Number(g.n ?? meta.n ?? 0);

  if (t === 'daily') return '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
  if (t === 'monthly') return '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
  if (t === 'every_n_days') {
    return n ? `‡∏£‡∏≤‡∏¢ ${n} ‡∏ß‡∏±‡∏ô` : '‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô';
  }
  return '‚Äî';
}

// ‡πÅ‡∏õ‡∏•‡∏á payCycleType / payCycleN ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢
function payCycleLabel(u){
  const t = String(u.payCycleType || u.settings?.payCycleType || '').toLowerCase();
  const n = Number(u.payCycleN ?? u.settings?.payCycleN ?? 0);

  if (t === 'daily') return '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
  if (t === 'monthly') return '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
  if (t === 'every_n_days') {
    return n ? `‡∏£‡∏≤‡∏¢ ${n} ‡∏ß‡∏±‡∏ô` : '‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô';
  }
  return '‚Äî';
}


/* ---------- APIs ---------- */
async function listEmployees(actor){
  const res = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/employees`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ actor }) });
  const j = await res.json().catch(()=> ({}));
  if (!res.ok || !j.ok) throw new Error(j?.error || ('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ('+res.status+')')); return j.data || [];
}
async function fetchLogs(lineUserId, monthKey, range) {
  const params = new URLSearchParams({ lineUserId });
  if (range?.periodStart && range?.periodEnd){ params.set('periodStart', range.periodStart); params.set('periodEnd', range.periodEnd); }
  else if (monthKey){ params.set('month', getMonthKey(monthKey)); }
  const url = `/api/tenants/${encodeURIComponent(TENANT)}/attendance/logs?${params}`;
  const r = await fetch(url).catch(() => null);
  const j = await (r ? r.json().catch(() => ({})) : {});
  if (!r || !r.ok || !j || j.ok === false) return { days: [], leave: [], summary: { workHours:0, workDays:0, leaveHours:0, leaveDays:0 } };
  const data = j.data || j;
  const leave = data.leave || data.leaveLogs || [];
  const summary = Object.assign({ workHours:0, workDays:0, leaveHours:0, leaveDays:0 }, data.summary || {});
  if (summary.leaveHours == null) summary.leaveHours = leave.reduce((s,l)=> s + Number(l.hours||0), 0);
  if (summary.leaveDays  == null) summary.leaveDays  = (new Set(leave.map(l=> l.date))).size;
  return { days: data.days || [], leave, summary };
}

/* ====== USERS (load fresh) ====== */
let __users = [];
let __empGroupIds = new Set();   // ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô editor ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

async function loadUsers(force=false){
  if (!force && __users.length) return __users;
  try { __users = await listEmployees(await getActor()) || []; }
  catch { __users = []; }
  return __users;
}

const $cards=document.getElementById('cards'); const $reload=document.getElementById('reload'); const $q=document.getElementById('q'); const $editor=document.getElementById('editor'); const $empTitle=document.getElementById('empTitle'); const $lazyNote=document.getElementById('lazyNote');
function notOwner(x){ const r=String(x.role||'').toLowerCase(); const jt=String(x.jobTitle||'').toLowerCase(); return r!=='owner' && jt!=='owner'; }
function renderCards(rows){
  $cards.innerHTML=''; const q = ($q?.value||'').toLowerCase(); let count=0;
  rows
    .filter(notOwner)
    .filter(x=> !q || `${x.fullName||''} ${x.jobTitle||''}`.toLowerCase().includes(q))
    .forEach(x=>{
      const el=document.createElement('div'); el.className='emp';

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ
      const payoutRaw = x.payoutChannel || x.settings?.payoutChannel || 'cash';
      const payoutText = payoutRaw === 'bank'
        ? '‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'
        : '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';

      el.innerHTML=`
        <div class="top">
          <div class="avatar">${initials(x.fullName||'User')}</div>
          <div style="flex:1">
            <div style="font-weight:700">${x.fullName||'-'}</div>
            <div class="muted">${x.jobTitle||'-'}</div>
          </div>
          <span class="chip">${(x.role||'user')}</span>
        </div>
        <div class="kv"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</b><div>${onlyDate(x.registerDate)||'-'}</div></div>
        <div class="kv"><b>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</b><div>${displayPay(x)} / ${money(x.payRate)}</div></div>
        <div class="kv"><b>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</b><div>${payoutText}</div></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" data-act="edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>`;
      el.querySelector('[data-act="edit"]').addEventListener('click',()=>openEditor(x));
      $cards.appendChild(el); count++;
    });
  $lazyNote.textContent = count ? '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
}

const val = id => document.getElementById(id).value;
const setv = (id, v) => document.getElementById(id).value = (v ?? '');

function bindPayTypeSeg(segId, selectId){
  const seg = document.getElementById(segId);
  const sel = document.getElementById(selectId);

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ seg ‡∏´‡∏£‡∏∑‡∏≠ select ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error
  if (!seg || !sel) return;

  const syncOn = () => {
    [...seg.querySelectorAll('button')].forEach(b =>
      b.classList.toggle('on', b.dataset.v === sel.value)
    );
  };

  seg.addEventListener('click', e => {
    const v = e.target?.dataset?.v;
    if (!v) return;
    sel.value = v;
    syncOn();
    togglePayEveryN();
  });

  sel.addEventListener('change', () => {
    syncOn();
    togglePayEveryN();
  });

  syncOn();
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ payTypeSeg ‡∏Å‡πá‡πÅ‡∏Ñ‡πà return ‡πÄ‡∏â‡∏¢‡πÜ
bindPayTypeSeg('payTypeSeg','payType');

/* helpers: bank + pay-type fields */
function toggleBankInputs(){
  const ch   = document.getElementById('payoutChannel')?.value || 'cash';
  const wrap = document.getElementById('bankWrap');
  const $bn  = document.getElementById('bankName');
  const $ba  = document.getElementById('bankAccount');

  const showBank = (ch === 'bank');

  if (wrap) wrap.style.display = showBank ? '' : 'none';
  [$bn,$ba].forEach(i=>{
    if (!i) return;
    i.disabled = !showBank;
  });
}

function updatePayRatePlaceholder(){
  const t = document.getElementById('payType')?.value || '';
  const input = document.getElementById('payRate');
  if (!input) return;
  if (t === 'monthly') input.placeholder = '‡πÄ‡∏ä‡πà‡∏ô 15000 (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)';
  else if (t === 'daily' || t === 'every_n_days') input.placeholder = '‡πÄ‡∏ä‡πà‡∏ô 400 (‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏ö)';
  else if (t === 'hourly' || t === 'every_n_hours') input.placeholder = '‡πÄ‡∏ä‡πà‡∏ô 60 (‡∏ö‡∏≤‡∏ó/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏ö)';
  else input.placeholder = '‡πÄ‡∏ä‡πà‡∏ô 15000 / 400 / 60';
}
function togglePayEveryN(){
  const t = document.getElementById('payType').value;
  const show = (t==='every_n_days' || t==='every_n_hours');
  document.getElementById('wrapPayEveryN').style.display = show ? '' : 'none';
  updatePayRatePlaceholder();
}
function togglePayCycleN(){
  const t = document.getElementById('payCycleType')?.value || '';
  const el = document.getElementById('wrapPayCycleN');
  if (!el) return;
  el.style.display = (t === 'every_n_days') ? '' : 'none';
}
const $payCycleType = document.getElementById('payCycleType');
if ($payCycleType){
  $payCycleType.addEventListener('change', togglePayCycleN);
}

async function openEditor(emp){
  document.getElementById('editor').classList.remove('hidden');
  document.getElementById('empTitle').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${emp.fullName || emp.lineUserId}`;

  // ‚úÖ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
  setv('lineUserId',     emp.lineUserId || '');
  setv('fullName',       emp.fullName || '');
  setv('nationalId',     emp.nationalId || '');
  setv('phone',          emp.phone || '');
  setv('birthDate',      onlyDate(emp.birthDate) || '');
  setv('gender',         emp.gender || '');
  setv('idAddress',      emp.idAddress || '');
  setv('currentAddress', emp.currentAddress || '');
  setv('jobTitle',       emp.jobTitle || '');
  setv('role',           (emp.role || 'user'));
  setv('registerDate',   onlyDate(emp.registerDate) || '');
  setv('bankName',       emp.bankName    || emp.settings?.bankName    || '');
  setv('bankAccount',    emp.bankAccount || emp.settings?.bankAccount || '');

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá default ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
  const defaultPayout =
    emp.payoutChannel || emp.settings?.payoutChannel ||
    ((emp.bankName || emp.bankAccount || emp.settings?.bankName || emp.settings?.bankAccount) ? 'bank' : 'cash');

  setv('payoutChannel',  defaultPayout);

  // ‚úÖ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡∏£‡∏≠‡∏ö)
  setv('payCycleType',   emp.payCycleType || emp.settings?.payCycleType || '');
  setv('payCycleN',      emp.payCycleN ?? emp.settings?.payCycleN ?? '');

  // ‚úÖ ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á/‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  setv('payType',        emp.payType || 'daily');
  setv('payRate',        emp.payRate || 0);
  setv('dailyHours',     emp.dailyHours || 8);
  setv('prorateLate',    (String(emp.prorateLate).toLowerCase()==='true' ? 'true' : 'false'));
  setv('payEveryN',      emp.payEveryN || '');
  setv('shiftIn',        emp.shiftIn || '');
  setv('shiftOut',       emp.shiftOut || '');
  setv('lateGraceMin',   emp.lateGraceMin || 0);

  // ‚úÖ quota ‡πÉ‡∏´‡∏°‡πà
  setv('breakMinutes',   emp.breakMinutes   ?? emp.settings?.breakMinutes   ?? '');
  setv('leaveQuotaDays', emp.leaveQuotaDays ?? emp.settings?.leaveQuotaDays ?? '');

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° payType ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö select
  [...document.querySelectorAll('#payTypeSeg button')].forEach(b=> 
    b.classList.toggle('on', b.dataset.v===val('payType'))
  );
  toggleBankInputs();
  togglePayEveryN();
  togglePayCycleN();
  document.getElementById('payoutChannel').onchange = toggleBankInputs;

  // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà
  await loadEmployeeGroupsForEditor(emp);

  // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö owner)
  const $remove = document.getElementById('remove');
  if ($remove){
    const isOwner = String(emp.role||'').toLowerCase()==='owner' ||
                    String(emp.jobTitle||'').toLowerCase()==='owner';
    $remove.disabled = !emp.lineUserId || isOwner;
    $remove.title = isOwner ? 'Owner ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ' : '';

    $remove.onclick = async ()=>{
      try{
        const id = val('lineUserId');
        if (!id){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ LINE User ID'); return; }
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

        const actor = await getActor();
        const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/employee/delete`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ actor, lineUserId:id })
        }).catch(()=>null);
        const j = await (r ? r.json().catch(()=>({})) : {});
        if (!r || !r.ok || !j.ok) throw new Error(j.error || 'delete_failed');

        setMsg('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','ok');
        document.getElementById('editor').classList.add('hidden');
        await primeUsers(true);
      }catch(e){
        alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e));
      }
    };
  }

  // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ã‡∏ü: ‡∏™‡πà‡∏á profile + settings + groupIds ‡πÑ‡∏õ server.js
  document.getElementById('save').onclick = async ()=>{
    try{
      setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶');
      const actor = await getActor();
      const groupIds = Array.from(__empGroupIds || []).filter(Boolean);

      const payload = {
        actor,
        profile: {
          lineUserId: val('lineUserId'),
          nationalId: val('nationalId'),
          fullName:   val('fullName'),
          idAddress:  val('idAddress'),
          currentAddress: val('currentAddress'),
          phone:      val('phone'),
          birthDate:  val('birthDate'),
          gender:     val('gender'),
          jobTitle:   val('jobTitle'),
          bankName:   document.getElementById('bankName').disabled ? '' : val('bankName'),
          bankAccount:document.getElementById('bankAccount').disabled ? '' : val('bankAccount'),
          registerDate:   val('registerDate')
        },
        settings: {
          // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡∏£‡∏≠‡∏ö)
          payCycleType:  val('payCycleType') || '',
          payCycleN:     Number(val('payCycleN') || 0),

          // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πâ‡∏≤‡∏á / ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
          payType:       val('payType'),
          payRate:       Number(val('payRate') || 0),
          dailyHours:    Number(val('dailyHours') || 8),
          prorateLate:   (val('prorateLate') === 'true'),
          payEveryN:     (['every_n_days','every_n_hours'].includes(val('payType')) ? (Number(val('payEveryN')||'')||'') : ''),
          shiftIn:       val('shiftIn'),
          shiftOut:      val('shiftOut'),
          lateGraceMin:  Number(val('lateGraceMin') || 0),
          payoutChannel: val('payoutChannel') || 'none',
          // ‚úÖ quota ‡πÉ‡∏´‡∏°‡πà
          breakMinutes:   Number(val('breakMinutes') || 0),
          leaveQuotaDays: Number(val('leaveQuotaDays') || 0),

          allowances:    [],
          deductions:    [],
        },
        role: val('role'),
        // ‚úÖ ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö API /admin/employee/save (server.js step 2)
        groupIds
      };

      const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/employee/save`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok || !j.ok) throw new Error(j?.error || 'save_failed');

      document.getElementById('saveMsg').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì';
      setMsg('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','ok');
      await primeUsers(true);
    }catch(e){
      document.getElementById('saveMsg').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e);
      setMsg('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message || e), 'err');
    }
  };
}
async function loadEmployeeGroupsForEditor(emp){
  const $box = document.getElementById('emp-groups');
  __empGroupIds = new Set();
  if (!$box) return;

  $box.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‚Ä¶</div>';
  try{
    // ‡πÉ‡∏ä‡πâ loadGroups ‡πÄ‡∏î‡∏¥‡∏° (‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡∏∂‡∏á /admin/paygroups + detail)
    await loadGroups(false);

    if (emp.lineUserId){
      const actor = await getActor();
      const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/employee/groups/get`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ actor, lineUserId: emp.lineUserId })
      }).catch(()=>null);
      const j = await (r ? r.json().catch(()=>({})) : {});
      const gids = (r && r.ok && j.ok && Array.isArray(j.groupIds)) ? j.groupIds : [];
      __empGroupIds = new Set(gids.filter(Boolean));
    } else {
      __empGroupIds = new Set();
    }

    renderEmpGroupsCheckboxes(false);
  }catch(e){
    console.error('[emp_groups_get] error', e);
    renderEmpGroupsCheckboxes(true);
  }
}

function renderEmpGroupsCheckboxes(hasError){
  const $box = document.getElementById('emp-groups');
  if (!$box) return;

  const groups = __groups || [];
  let html = '';

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  if (!groups.length){
    html += `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>`;
  }

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° (checkbox)
  html += groups.map(g=>{
    const checked = __empGroupIds.has(g.groupId) ? 'checked' : '';
    const sub = groupTypeLabel(g);
    return `
      <label style="display:flex;align-items:center;gap:6px;font-size:13px;padding:3px 4px">
        <input type="checkbox" data-gid="${g.groupId}" ${checked}
               style="width:auto;height:auto">
        <span><b>${g.name || g.groupId}</b> <span class="muted">¬∑ ${sub}</span></span>
      </label>
    `;
  }).join('');

  // ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î)
  html += `
    <button type="button" class="btn-ghost" id="btnCreatePaygroupFromEmp"
            style="margin-top:6px;width:100%">
      ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    </button>
  `;

  $box.innerHTML = html;

  // ‡∏ú‡∏π‡∏Å event ‡∏Å‡∏±‡∏ö checkbox ‡∏Å‡∏•‡∏∏‡πà‡∏°
  [...$box.querySelectorAll('[data-gid]')].forEach(ch=>{
    ch.addEventListener('change', ()=>{
      const gid = ch.dataset.gid;
      if (!gid) return;
      if (ch.checked) __empGroupIds.add(gid);
      else __empGroupIds.delete(gid);
    });
  });

  // ‡∏ú‡∏π‡∏Å event ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‚Äù
  const btn = document.getElementById('btnCreatePaygroupFromEmp');
  if (btn){
    btn.addEventListener('click', ()=>{
      // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô hash ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      __afterRoute = ()=> setPayrollTab('cycles');
      location.hash = '#payroll';
    });
  }

  if (hasError){
    const warn = document.createElement('div');
    warn.className = 'err';
    warn.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
    $box.appendChild(warn);
  }
}



/* ---------- LOGS ---------- */
const $cards2=document.getElementById('cards2'); const $q2=document.getElementById('q2'); const $lazy2=document.getElementById('lazyNote2');
const $panelLogs=document.getElementById('panelLogs'); const $logTitle=document.getElementById('logTitle'); const $logStatus=document.getElementById('logStatus');
const $summary=document.getElementById('summaryBox'); const $month=document.getElementById('month'); const $tbody=document.getElementById('logTbody');
$month.value = getMonthKey(FORCED_MONTH) || todayMonthKey();
function lateMinutesForDay(d, shiftIn, graceMin){
  if (!d?.inTime || !shiftIn) return 0; const s=parseHm(shiftIn); if(!s) return 0;
  const inAt=new Date(d.inTime); const sch=new Date(inAt); sch.setHours(s.h, s.m, 0, 0);
  const diffMin=Math.round((inAt-sch)/60000); return Math.max(0, diffMin - (Number(graceMin||0)));
}
async function renderUserStripLogs(){
  $cards2.innerHTML=''; $lazy2.textContent = '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Ä¶';
  const rows = __users; const q = ($q2?.value || '').toLowerCase(); let count=0;
  rows.filter(notOwner).filter(x => !q || `${x.fullName||''} ${x.jobTitle||''}`.toLowerCase().includes(q)).forEach(x=>{
    const el=document.createElement('div'); el.className='emp';
    el.innerHTML=`
      <div class="top">
        <div class="avatar">${initials(x.fullName||'User')}</div>
        <div style="flex:1">
          <div style="font-weight:700">${x.fullName||'-'}</div>
          <div class="muted">${x.jobTitle||'-'}</div>
        </div>
        <span class="chip">${(x.role||'user')}</span>
      </div>
      <div class="kv"><b>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</b><div>${displayPay(x)} / ${money(x.payRate)}</div></div>

      <div style="margin-top:10px;display:flex;gap:8px"><button class="btn" data-act="view">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button></div>`;
    el.querySelector('[data-act="view"]').addEventListener('click',()=> openLogs(x));
    $cards2.appendChild(el); count++;
  });
  $lazy2.textContent = count ? '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠';
}
$q2.oninput = renderUserStripLogs;
$month.onchange = ()=>{ if (CURRENT_USER) openLogs(CURRENT_USER); };
let CURRENT_USER=null;
async function openLogs(emp){
  CURRENT_USER = emp;
  $panelLogs.classList.remove('hidden');
  $logTitle.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${emp.fullName || emp.lineUserId}`;
  $logStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶';
  $tbody.innerHTML = ''; $summary.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‚Ä¶';
  const m = getMonthKey($month.value) || todayMonthKey();
  const { days, leave, summary } = await fetchLogs(emp.lineUserId, m);
  const leaveByDate={}; (leave||[]).forEach(l=>{ (leaveByDate[l.date]||(leaveByDate[l.date]=[])).push(l); });
  const shiftIn = emp.shiftIn || ''; const grace = Number(emp.lateGraceMin||0);
  let totalLateMin = 0;
  (days||[]).forEach(d=>{
    const inTxt  = d.inTime  ? new Date(d.inTime).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : '-';
    const outTxt = d.outTime ? new Date(d.outTime).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}) : '-';
    const lateMin = lateMinutesForDay(d, shiftIn, grace); totalLateMin += lateMin;
    const loc = `${d.inAddr||'-'}${d.outAddr?(' ‚Üí '+d.outAddr):''}`;
    const leaveTxt = (leaveByDate[d.date]||[]).map(l=> (l.reason||'‡∏•‡∏≤') + (l.hours?` ${l.hours}‡∏ä‡∏°.`:'')).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${d.date}</td>
      <td>${inTxt}</td>
      <td>${outTxt}</td>
      <td style="text-align:right">${Number(d.hours||0).toFixed(2)}</td>
      <td style="text-align:right">${lateMin}</td>
      <td style="min-width:260px">${loc}</td>
      <td style="color:#0ea5e9">${leaveTxt||''}</td>`;
    $tbody.appendChild(tr);
  });
  const workHours = Number(summary?.workHours || 0);
  const workDays  = Number(summary?.workDays  || 0);
  const lateHours = totalLateMin/60;

  const payType     = String(emp.payType || 'daily');
  const payRate     = Number(emp.payRate || 0);
  const dailyHours  = Number(emp.dailyHours || 8);
  const prorateLate = String(emp.prorateLate||'false').toLowerCase()==='true';

  let basePay=0, hourlyForLate=0;
  if (payType==='hourly'){
    basePay = workHours*payRate;
    hourlyForLate = payRate;
  } else if (payType==='daily'){
    basePay = workDays*payRate;
    hourlyForLate = dailyHours>0 ? (payRate/dailyHours) : 0;
  } else if (payType==='monthly'){
    basePay = payRate;
    const { first, last } = monthRangeStr(m);
    const daysInThisMonth = daysBetweenInclusive(first,last);
    hourlyForLate = (dailyHours>0) ? ((payRate/daysInThisMonth)/dailyHours) : 0;
  } else if (payType==='every_n_days'){
    basePay = (workDays/Number(emp.payEveryN||0))*payRate;
    hourlyForLate = dailyHours>0 ? (payRate/dailyHours) : 0;
  } else if (payType==='every_n_hours'){
    basePay = (workHours/Number(emp.payEveryN||0))*payRate;
    hourlyForLate = payRate/Number(emp.payEveryN||1);
  }

  let lateDeduct=0;
  if (prorateLate && hourlyForLate>0 && payType!=='hourly') lateDeduct = hourlyForLate * lateHours;
  const netPay = Math.max(0, basePay - lateDeduct);

  $summary.innerHTML = `
    <div style="font-weight:700;margin-bottom:6px">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${m}</div>
    <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° <b>${workDays}</b> ‡∏ß‡∏±‡∏ô ‚Ä¢ ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° <b>${workHours.toFixed(2)}</b> ‡∏ä‡∏°. ‚Ä¢ ‡∏™‡∏≤‡∏¢ <b>${lateHours.toFixed(2)}</b> ‡∏ä‡∏°.</div>
    <hr style="border:none;border-top:1px dashed #e2e8f0;margin:8px 0">
    <div>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢: <b>${displayPay(emp)}</b> ‚Äî ‡∏≠‡∏±‡∏ï‡∏£‡∏≤: <b>${payRate.toLocaleString()}</b></div>
    <div>‡∏ê‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢: <b>${basePay.toLocaleString(undefined,{maximumFractionDigits:2})}</b> ‚Ä¢ ‡∏´‡∏±‡∏Å‡∏™‡∏≤‡∏¢: <b>${lateDeduct.toLocaleString(undefined,{maximumFractionDigits:2})}</b></div>
    <div style="font-size:16px;margin-top:4px">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <b>${netPay.toLocaleString(undefined,{maximumFractionDigits:2})}</b></div>
  `;
}


/* ---------- PAYROLL (tabs, groups) ---------- */
const $tabPayrun   = document.getElementById('tab-payrun');
const $tabCycles   = document.getElementById('tab-cycles');
const $tabPayments = document.getElementById('tab-payments');

const $panePayrun   = document.getElementById('pane-payrun');
const $paneCycles   = document.getElementById('pane-cycles');
const $panePayments = document.getElementById('pane-payments');

function setPayrollTab(name){
  [$tabPayrun,$tabCycles,$tabPayments].forEach(b=> b.classList.remove('on'));
  [$panePayrun,$paneCycles,$panePayments].forEach(p=> p.classList.add('hidden'));

  if (name==='cycles'){
    $tabCycles.classList.add('on');
    $paneCycles.classList.remove('hidden');
  } else if (name==='payments'){
    $tabPayments.classList.add('on');
    $panePayments.classList.remove('hidden');
  } else {
    $tabPayrun.classList.add('on');
    $panePayrun.classList.remove('hidden');
  }

  // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á Due Today ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏ö "‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
  const dueBox = document.getElementById('pr-due');
  if (dueBox) {
    dueBox.classList.toggle('hidden', name !== 'payrun');
  }
}
function currentPayrollTab(){
  if (!$paneCycles.classList.contains('hidden')) return 'cycles';
  if (!$panePayments.classList.contains('hidden')) return 'payments';
  return 'payrun';
}

/* ====== PATCH 1: tab handlers (no double prime) ====== */
document.getElementById('pr-global-refresh')?.addEventListener('click', refreshPayrollUI);
$tabPayrun.onclick = ()=>{
  setPayrollTab('payrun');
  // ‡πÑ‡∏°‡πà prime ‡∏ã‡πâ‡∏≥ ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ route/refresh ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏≠
  loadDueToday(true);
};
$tabCycles.onclick = ()=>{
  setPayrollTab('cycles');
};
$tabPayments.onclick = ()=>{
  setPayrollTab('payments');
  if (!$pyRun.options || $pyRun.options.length <= 1) {
    primePayments(true);
  }
};

// ===== DUE TODAY (Reminders) =====
function todayYMD(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

const $dueDate    = document.getElementById('dueTodayInput');
const $btnLoadDue = document.getElementById('btnLoadDue');
const $btnNotify  = document.getElementById('btnNotifyToday');
const $dueList    = document.getElementById('dueList');
const $dueStat    = document.getElementById('dueStat');
let __dueLastList = [];

if ($dueDate && !$dueDate.value) $dueDate.value = todayYMD();

let __dueLoading = false;
let __dueLastAt = 0;
const __DUE_MIN_INTERVAL = 8000;

// ‚úÖ ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ
function endOfMonthYMD(d){
  const dt = (d instanceof Date)? d : new Date(d);
  const last = new Date(dt.getFullYear(), dt.getMonth()+1, 0);
  return `${last.getFullYear()}-${String(last.getMonth()+1).padStart(2,'0')}-${String(last.getDate()).padStart(2,'0')}`;
}
// ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì "‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å today + payDayOfMonth (1‚Äì31 ‡∏´‡∏£‡∏∑‡∏≠ 'last')
function monthlyPayDateYMD(todayYMD, payDayOfMonth){
  const [Y,M] = todayYMD.split('-').map(Number);
  const mk = (y,m,d)=> `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

  const thisLast = new Date(Y, M, 0).getDate();
  const useLast  = (payDayOfMonth === 'last');
  const dayNum   = useLast ? thisLast : Math.min(Number(payDayOfMonth||1), 31);

  const today   = new Date(todayYMD);
  const payThis = new Date(Y, M-1, dayNum);

  // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
  if (today <= payThis) return mk(Y, M, dayNum);

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  const nY = (M===12)? (Y+1) : Y;
  const nM = (M===12)? 1 : (M+1);
  const nextLast = new Date(nY, nM, 0).getDate();
  const nDay = useLast ? nextLast : Math.min(dayNum, 31);

  return mk(nY, nM, nDay);
}

async function loadDueToday(force=false){
  try{
    if (!$dueList) return;
    const nowTs = Date.now();
    if (!force && (__dueLoading || (nowTs - __dueLastAt) < __DUE_MIN_INTERVAL)) return;

    __dueLoading = true;
    __dueLastAt = nowTs;

    const today = $dueDate?.value || todayYMD();
    $dueList.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    $dueStat.textContent = '';

    const actor = await getActor();
    const qs = new URLSearchParams({
      today,
      actor: actor.lineUserId,
      actorLineUserId: actor.lineUserId
    });

    const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/paygroups/reminder-due?${qs}`, {
      method: 'GET',
      headers: {
        'Accept':'application/json',
        'Authorization': await getBearer()
      },
      credentials: 'include'
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'error');

    const payload  = j.duePayload || {};
    const due      = Array.isArray(payload.due) ? payload.due : [];
    __dueLastList = due;
    const adminIds = Array.isArray(payload.adminIds) ? payload.adminIds : [];

    $dueStat.textContent = `‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: ${adminIds.length} ‡∏Ñ‡∏ô ¬∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${payload.today || today}`;

    if (!due.length){
      $dueList.innerHTML = `<div class="muted">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (${today}) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>`;
    } else {
      const html = [
        `<div class="table-wrap"><table class="log">`,
        `<thead><tr><th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î</th><th>‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢</th></tr></thead><tbody>`,
        ...due.map(g=>{
          const name = g.name || g.groupId || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°)';
          const type = String(g.type || '').toLowerCase();

          let payTxt = g.payDate || '';

          // ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å N ‡∏ß‡∏±‡∏ô: ‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢ = ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î (periodEnd + 1)
          if (type === 'every_n_days' && g.periodEnd) {
            const d = new Date(g.periodEnd);
            if (!isNaN(d)) {
              d.setDate(d.getDate() + 1);
              payTxt = ymdLocal(d); // helper ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            }
          }

          // ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏ñ‡πâ‡∏≤ backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì payTxt ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏≠‡∏á‡∏à‡∏≤‡∏Å payDayOfMonth
          if ((!payTxt || payTxt === '‚Äî') && type === 'monthly'){
            const meta = g.meta || {};
            const pdom = g.payDayOfMonth ?? meta.payDayOfMonth ?? g.payDay ?? meta.payDay ?? null;
            if (pdom != null && ($dueDate?.value)){
              const as = String(pdom).toLowerCase() === 'last' ? 'last' : Number(pdom);
              payTxt = monthlyPayDateYMD($dueDate.value, as);
            }
          }

          // ‚úÖ ‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î
          let range = '‚Äî';
          if (g.periodStart && g.periodEnd){
            range = `${g.periodStart} ‚Üí ${g.periodEnd}`;
          } else if (type === 'monthly' && payTxt){
            const d = new Date(payTxt);
            const first = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
            const last  = endOfMonthYMD(d);
            range = `${first} ‚Üí ${last}`;
          }

          const pay = payTxt || '‚Äî';
          return `<tr><td>${name}</td><td>${range}</td><td>${pay}</td></tr>`;
        }),
        `</tbody></table></div>`
      ].join('');
      $dueList.innerHTML = html;
    }
  }catch(e){
    $dueList.innerHTML = `<div class="err">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message || e}</div>`;
  } finally {
    __dueLoading = false;
  }
}

async function notifyDueToday(){
  try{
    const today = $dueDate?.value || todayYMD();
    const actor = await getActor();
    $btnNotify.disabled = true; $btnNotify.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

    const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/paygroups/notify-run`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Accept':'application/json',
        'Authorization': await getBearer()
      },
      credentials:'include',
      body: JSON.stringify({ today, actor })
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'error');

    showDialog('‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    loadDueToday(true);

  }catch(e){
    alert('‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message || e));
  }finally{
    $btnNotify.disabled = false; $btnNotify.textContent = '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
  }
}

$btnLoadDue?.addEventListener('click', ()=>loadDueToday(true));
$btnNotify?.addEventListener('click', notifyDueToday);

/* ====== PATCH 6: lean refresh ====== */
/* ====== PATCH 6: lean refresh ====== */
async function refreshPayrollUI(){
  try{
    setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Ä¶');

    const tab = currentPayrollTab();   // ‚úÖ ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà tab ‡πÑ‡∏´‡∏ô

    if (tab === 'payrun') {
      // TAB 1: ‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      __groupsCacheAt = 0;               // invalidate groups cache
      await primePayroll(true);          // loadUsers + loadGroups
      await loadDueToday(true);          // ‡πÇ‡∏´‡∏•‡∏î Due Today ‡πÉ‡∏´‡∏°‡πà
      document.getElementById('pr-body').innerHTML = '';
      document.getElementById('pr-total').textContent = '0.00';
      $prMsg.textContent = '';
    } else if (tab === 'cycles') {
      // TAB 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      __groupsCacheAt = 0;
      await loadUsers(true);
      await loadGroups(true);
      renderCyclesTable();
      $pgEditor.classList.add('hidden');
      $pgMsg.textContent = '';
    } else if (tab === 'payments') {
      // TAB 3: ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      await loadUsers(true);
      await primePayments(true);   // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ runs ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      await reloadPayments();      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ approved/paid ‡πÉ‡∏´‡∏°‡πà
    }

    setMsg('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß','ok');
  }catch(e){
    console.error(e);
    setMsg('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (e.message||e), 'err');
  }
}


const $prGroup = document.getElementById('pr-group');
const $prStart = document.getElementById('pr-start');
const $prEnd   = document.getElementById('pr-end');
const $prQ     = document.getElementById('pr-q');
const $prDraft = document.getElementById('pr-draft');
const $prBody  = document.getElementById('pr-body');
const $prTotal = document.getElementById('pr-total');
const $prMsg   = document.getElementById('pr-msg');
const $prCheckAll = document.getElementById('pr-checkall');
const $prStatus = document.getElementById('pr-status');
const $prMembersBox   = document.getElementById('pr-members-box');
const $prMembersList  = document.getElementById('pr-members-list');
const $prMembersCount = document.getElementById('pr-members-count');

/* NEW: elements for edit-run chips */
const $prRunBox = document.getElementById('pr-run-box');
const $prRunIdChip = document.getElementById('pr-runid-chip');
const $prRunMembers = document.getElementById('pr-run-members');

/* Default period (first load only) */
(function initDefaultRange(){
  if ($prStart.value && $prEnd.value) return;
  const d=new Date(); const first=new Date(d.getFullYear(), d.getMonth(), 1); const last=new Date(d.getFullYear(), d.getMonth()+1, 0);
  $prStart.value = `${first.getFullYear()}-${pad2(first.getMonth()+1)}-${pad2(first.getDate())}`;
  $prEnd.value   = `${last.getFullYear()}-${pad2(last.getMonth()+1)}-${pad2(last.getDate())}`;
})();

/* Persist period & normalize */
const PERIOD_KEY = `ta_pr_period_${TENANT}`;
function loadSavedPeriod(){
  try{
    const j = JSON.parse(sessionStorage.getItem(PERIOD_KEY)||'{}');
    if (j.start && j.end){ $prStart.value = j.start; $prEnd.value = j.end; }
  }catch{}
}
function savePeriod(){ sessionStorage.setItem(PERIOD_KEY, JSON.stringify({ start:$prStart.value, end:$prEnd.value })); }
function normalizePeriod(){
  if (!$prStart.value || !$prEnd.value) return;
  const s = new Date($prStart.value), e = new Date($prEnd.value);
  if (!isNaN(s) && !isNaN(e) && s > e){ const t=$prStart.value; $prStart.value=$prEnd.value; $prEnd.value=t; }
}
let USER_TOUCHED_PERIOD = false;
[$prStart,$prEnd].forEach(i=>{
  i.addEventListener('change', ()=>{ 
    USER_TOUCHED_PERIOD = true; normalizePeriod(); savePeriod(); 
    __editingRunId = null; __editRunMembers = null; $prRunBox.classList.add('hidden');
  });
});
loadSavedPeriod();

let __payDraft = [];
let __groups = [];
let __groupMembers = {}; // groupId -> Set(lineUserId)
let __draftSeq = 0;      // PATCH 5: cancel stale compute

function recomputeTotal(){
  let s=0;
  [...$prBody.querySelectorAll('tr')].forEach(tr=>{
    const cb = tr.querySelector('input[type="checkbox"]');
    if (!cb || !cb.checked) return;
    const net = Number(tr.querySelector('[data-net]')?.dataset.net || 0);
    s += net;
  });
  $prTotal.textContent = s.toLocaleString(undefined,{maximumFractionDigits:2});
}
function renderGroupMembers(gid){
  const ids = __groupMembers[gid];
  if (ids && ids.size > 0){
    const users = (__users || []).filter(u => ids.has(u.lineUserId));
    $prMembersCount.textContent = String(users.length);
    $prMembersList.innerHTML = users.map(u =>
      `<span class="chip" title="${u.lineUserId}">${u.fullName || u.lineUserId}</span>`
    ).join(' ');
    $prMembersBox.classList.remove('hidden');
  } else {
    $prMembersCount.textContent = '0';
    $prMembersList.innerHTML = '';
    $prMembersBox.classList.add('hidden');
  }
}

/* helper: render chips for edit-run members */
function renderEditRunChips(){
  if (!__editingRunId || !(__editRunMembers instanceof Set) || __editRunMembers.size===0){
    $prRunBox.classList.add('hidden');
    return;
  }
  $prRunIdChip.textContent = __editingRunId;
  const users = (__users||[]).filter(u => __editRunMembers.has(u.lineUserId));
  $prRunMembers.innerHTML = users.map(u =>
    `<span class="chip" title="${u.lineUserId}">${u.fullName||u.lineUserId}</span>`
  ).join(' ');
  $prRunBox.classList.remove('hidden');
  $prMembersBox.classList.add('hidden');
}

$prCheckAll.onchange = ()=>{
  [...$prBody.querySelectorAll('input[type="checkbox"]')].forEach(cb=> cb.checked = $prCheckAll.checked);
  recomputeTotal();
};

function rowHTML(r){
  return `
    <td><input type="checkbox" checked></td>
    <td>${r.fullName || '-'}</td>
    <td>${r.jobTitle || '-'}</td>
    <td>${displayPay(r)}</td>
    <td style="text-align:right">${Number(r.payRate||0).toLocaleString()}</td>
    <td style="text-align:right">${r.workDays}</td>
    <td style="text-align:right">${r.workHours.toFixed(2)}</td>
    <td style="text-align:right">${r.lateHours.toFixed(2)}</td>
    <td style="text-align:right">${(r.leaveHours||0).toFixed(2)}</td>
    <td style="text-align:right">${r.basePay.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
    <td><input class="adjMinus" type="number" step="0.01" value="${r.adjMinus||0}" style="width:110px"></td>
    <td><input class="adjPlus"  type="number" step="0.01" value="${r.adjPlus||0}"  style="width:110px"></td>
    <td data-net="${r.netPay.toFixed(2)}" style="text-align:right"><b>${r.netPay.toLocaleString(undefined,{maximumFractionDigits:2})}</b></td>
    <td><input class="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" value="${(r.note||'').replace(/"/g,'&quot;')}" style="width:160px"></td>
    <td class="status-col"><span class="pr-status muted">‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</span></td>
  `;
}

/* ‡∏ê‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢ (monthly = ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏ï‡πá‡∏°) */
function parsePayBase(emp, logs, period){
  const { days, summary } = logs;
  const shiftIn = emp.shiftIn || ''; const grace = Number(emp.lateGraceMin||0);
  let lateMinTotal=0; (days||[]).forEach(d=> lateMinTotal += lateMinutesForDay(d, shiftIn, grace));
  const lateHours = lateMinTotal/60;
  const workHours = Number(summary?.workHours||0);
  const workDays  = Number(summary?.workDays||0);

    // üîπ ‡∏î‡∏∂‡∏á‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡∏à‡∏≤‡∏Å GAS /attendance/logs)
  const leaveHours = Number(summary?.leaveHours || 0);
  const leaveDays  = Number(summary?.leaveDays  || 0);
  
  const payType   = String(emp.payType||'daily');
  const payRate   = Number(emp.payRate||0);
  const dailyHours= Number(emp.dailyHours||8);
  const payEveryN = Number(emp.payEveryN||0);

  const daysInPeriod = (period?.periodStart && period?.periodEnd)
    ? daysBetweenInclusive(period.periodStart, period.periodEnd)
    : 30;

  let basePay=0, hourlyForLate=0;
  if (payType==='hourly'){
    basePay = workHours * payRate;
    hourlyForLate = payRate;
  } else if (payType==='daily'){
    basePay = workDays * payRate;
    hourlyForLate = dailyHours>0 ? (payRate/dailyHours) : 0;
  } else if (payType==='monthly'){
    basePay = payRate;
    hourlyForLate = (dailyHours>0) ? ((payRate/daysInPeriod)/dailyHours) : 0;
  } else if (payType==='every_n_days' && payEveryN>0){
    basePay = (workDays/payEveryN) * payRate;
    hourlyForLate = dailyHours>0 ? (payRate/dailyHours) : 0;
  } else if (payType==='every_n_hours' && payEveryN>0){
    basePay = (workHours/payEveryN) * payRate;
    hourlyForLate = payRate/payEveryN;
  }

  let lateDeduct=0;
    if (String(emp.prorateLate||'false').toLowerCase()==='true' && hourlyForLate>0 && payType!=='hourly'){
    lateDeduct = hourlyForLate * lateHours;
  }
  return {
    workDays,
    workHours,
    lateHours,
    leaveHours,   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    basePay,
    lateDeduct,
    payType,
    payRate,
    dailyHours,
    payEveryN
  };
}


async function computeOne(emp, periodStart, periodEnd){
  const logs = await fetchLogs(emp.lineUserId, null, { periodStart, periodEnd });
  const calc = parsePayBase(emp, logs, { periodStart, periodEnd });
  return {
    ...emp, ...calc,
    adjMinus: 0, adjPlus: 0, note: '',
    netPay: Math.max(0, calc.basePay - calc.lateDeduct),
    status: 'approved'
  };
}

/* ====== PATCH 4: loadGroups cache + parallel details ====== */
let __groupsCacheAt = 0;
const __GROUPS_TTL_MS = 10_000;

async function loadGroups(force=false){
  const now = Date.now();
  if (!force && __groups?.length && (now - __groupsCacheAt) < __GROUPS_TTL_MS) {
    // ‡πÉ‡∏ä‡πâ cache
  } else {
    const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/paygroups`).catch(()=>null);
    const j = await (r ? r.json().catch(()=>({})) : {});
    __groups = j?.data || [];
    __groupsCacheAt = now;
  }

  const missing = (__groups||[]).filter(g => !(__groupMembers[g.groupId] instanceof Set));
  const detailList = await Promise.all(missing.map(g => fetchGroupDetail(g.groupId).catch(()=>({}))));
  detailList.forEach((det, idx)=>{
    const gid = missing[idx].groupId;
    __groupMembers[gid] = new Set((det.members||det.memberIds||[]).map(x=> x.lineUserId || x));
  });

 
  $prGroup.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏ß‡∏î ‚Äî</option>` +
    (__groups||[]).map(g =>
      `<option value="${g.groupId}">${g.name} ¬∑ ${groupTypeLabel(g)}</option>`
    ).join('');


  renderGroupsOverview();
  renderCyclesTable();
}


async function fetchGroupDetail(groupId){
  try{
    const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/paygroups/${groupId}`).catch(()=>null);
    const j = await (r ? r.json().catch(()=>({})) : {});
    return j?.data || {};
  }catch{ return {}; }
}
// ‡πÉ‡∏ä‡πâ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" (‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Due Today ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏õ‡πá‡∏ô anchor ‡πÄ‡∏™‡∏°‡∏≠
function computePeriodFromGroup(g){
  if (!g) return null;

  // üîπ anchorDay = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á Due Today
  let anchorStr = '';
  const $due = document.getElementById('dueTodayInput');
  if ($due && $due.value) {
    anchorStr = $due.value;          // ‡πÄ‡∏ä‡πà‡∏ô 2025-11-15
  } else {
    anchorStr = todayYMD();          // helper ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  }

  const anchor = new Date(anchorStr);
  if (isNaN(anchor)) return null;

  const toYMD = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const type  = String(g.type || '').toLowerCase();
  const meta  = g.meta || {};
  const N     = Number(g.n ?? meta.n ?? 0);

  // üîπ ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ‚Üí ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á anchor (1 ‚Üí last)
  if (type === 'monthly'){
    const first = new Date(anchor.getFullYear(), anchor.getMonth(), 1);
    const last  = new Date(anchor.getFullYear(), anchor.getMonth()+1, 0);
    return { start: toYMD(first), end: toYMD(last) };
  }

  // üîπ ‡∏Å‡∏•‡∏∏‡πà‡∏° "‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô"
  //     ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 15, N=3 ‚Üí ‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î = 12‚Äì14 (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
  if (type === 'every_n_days' && N > 0){
    // ‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏≠‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏¢‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ)
    const rawStart = onlyDate(
      g.startDate || meta.startDate || meta.baseDate || ''
    );
    const start0 = rawStart ? new Date(rawStart) : null;

    // anchorDay = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Due Today) ‡∏ï‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å
    const anchorDay = new Date(anchor.getFullYear(), anchor.getMonth(), anchor.getDate());

    // ‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏á‡∏ß‡∏î = ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô anchor
    const end = new Date(anchorDay);
    end.setDate(end.getDate() - 1);  // ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ 15 ‚Üí end = 14

    // ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = ‡∏ñ‡∏≠‡∏¢‡∏à‡∏≤‡∏Å end ‡πÑ‡∏õ N-1 ‡∏ß‡∏±‡∏ô
    const start = new Date(end);
    start.setDate(start.getDate() - (N - 1));   // N=3 ‚Üí 14 - (3-1) = 12

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ start < ‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô ‚Üí ‡∏î‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô
    if (start0 && !isNaN(start0) && start < start0){
      start.setTime(start0.getTime());
      if (start > end) return null;
    }

    return { start: toYMD(start), end: toYMD(end) };
  }

  // üîπ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô daily ‚Üí ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß = anchor
  if (type === 'daily'){
    const d = new Date(anchor.getFullYear(), anchor.getMonth(), anchor.getDate());
    return { start: toYMD(d), end: toYMD(d) };
  }

  return null;
}


function maybeSyncPeriodToGroup(g){
  if (!g) return;
  // ‡∏ñ‡πâ‡∏≤ user ‡πÄ‡∏Ñ‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏∏‡πà‡∏á
  if (USER_TOUCHED_PERIOD) return;

  const p = computePeriodFromGroup(g);
  if (!p || !p.start || !p.end) return;

  $prStart.value = p.start;
  $prEnd.value   = p.end;
  savePeriod();
}

/* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (TAB1) */
function renderGroupsOverview(){
  const tb = document.getElementById('pr-groups-tbody');
  const users = __users || [];
  tb.innerHTML = (__groups||[]).map(g=>{

    const meta = g.meta || {};
    const sub  = groupTypeLabel(g);

    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô/‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢"
    let baseTxt = '‚Äî';
    const type = String(g.type || '').toLowerCase();

    if (type === 'monthly') {
      // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢ (1‚Äì31 ‡∏´‡∏£‡∏∑‡∏≠ last)
      const rawPd = (g.payDayOfMonth ?? g.payDay ?? meta.payDayOfMonth ?? meta.payDay ?? '')
        .toString()
        .trim()
        .toLowerCase();

      if (rawPd) {
        if (rawPd === 'last') {
          baseTxt = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
        } else {
          baseTxt = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${rawPd}`;
        }
      }
    } else {
      // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô: ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô)
      const rawBase =
        meta.startDate || meta.baseDate || meta.anchorDate || meta.start ||
        g.startDate   || g.baseDate   || g.anchorDate   || g.start   || '';

      const ymd = onlyDate(rawBase);
      baseTxt = ymd || '‚Äî';
    }

    const ids = __groupMembers[g.groupId] || new Set();
    const memCount = ids.size || 0;

    const previewUsers = users.filter(u => ids.has(u.lineUserId)).slice(0,8);
    const more = Math.max(0, memCount - previewUsers.length);
    const chips = previewUsers
      .map(u=>`<span class="chip" title="${u.lineUserId}">${u.fullName||u.lineUserId}</span>`)
      .join(' ');
    const moreTxt = more>0 ? ` <span class="chip">+${more}</span>` : '';

    return `<tr data-gid="${g.groupId}">
      <td style="display:flex; gap:6px; align-items:center">
        <button class="btn-ghost" data-pick="${g.groupId}">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      </td>
      <td>${g.name || g.groupId}</td>
      <td>${sub}</td>
      <td class="nowrap">${baseTxt}</td>
      <td>${chips}${moreTxt || (memCount===0?'<span class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚Äî</span>':'')}</td>
    </tr>`;
  }).join('');

  [...tb.querySelectorAll('[data-pick]')].forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const gid = btn.dataset.pick;
      $prGroup.value = gid;

      // ‚úÖ sync ‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á
      const g = (__groups || []).find(x => x.groupId === gid);
      if (g) maybeSyncPeriodToGroup(g);

      const det = await fetchGroupDetail(gid);
      const ids = new Set((det.members||det.memberIds||[]).map(x=> x.lineUserId || x));
      __groupMembers[gid] = ids;
      renderGroupMembers(gid);
      $prStatus.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Äù';
      __editingRunId = null; __editRunMembers = null; $prRunBox.classList.add('hidden');
      document.getElementById('pr-start').disabled = false;
      document.getElementById('pr-end').disabled   = false;
    });
  });
}


$prGroup.onchange = async ()=>{
  __editingRunId = null;  
  __editRunMembers = null;
  $prRunBox.classList.add('hidden');
  const gid = $prGroup.value;
  if (!gid){
    $prStatus.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
    $prMembersBox.classList.add('hidden');
    return;
  }

  // ‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á)
  const g = (__groups || []).find(x => x.groupId === gid);
  if (g) maybeSyncPeriodToGroup(g);

  await loadUsers(true);
  const det = await fetchGroupDetail(gid);
  const ids = new Set((det.members||det.memberIds||[]).map(x=> x.lineUserId || x));
  __groupMembers[gid] = ids;
  renderGroupMembers(gid);
  $prStatus.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Äù';
};


/* ====== PATCH 5: cancel stale draft ====== */
async function draftCompute(periodStart, periodEnd){
  normalizePeriod(); savePeriod();
  const mySeq = ++__draftSeq;

  const q = ($prQ.value||'').toLowerCase();
  $prBody.innerHTML = ''; $prStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Ä¶';

  let rows = (__users||[]).filter(notOwner)
                 .filter(x => !q || `${x.fullName||''} ${x.jobTitle||''}`.toLowerCase().includes(q));
  const gid = $prGroup.value || '';

  if (__editingRunId && (__editRunMembers instanceof Set) && __editRunMembers.size>0){
    rows = rows.filter(u => __editRunMembers.has(u.lineUserId));
    renderEditRunChips();
  } else if (gid && __groupMembers[gid] instanceof Set && __groupMembers[gid].size>0){
    renderGroupMembers(gid);
    rows = rows.filter(u => __groupMembers[gid].has(u.lineUserId));
  } else {
    $prMembersBox.classList.add('hidden');
    $prRunBox.classList.add('hidden');
  }

  const out = [];
  for (const emp of rows) {
    if (mySeq !== __draftSeq) return; // ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ã‡∏á
    out.push(await computeOne(emp, periodStart, periodEnd));
  }
  if (mySeq !== __draftSeq) return; // ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ã‡∏á

  __payDraft = out;
  $prBody.innerHTML = '';
  out.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = rowHTML(r);
    const bind = ()=>{
      const minus = Number(tr.querySelector('.adjMinus').value||0);
      const plus  = Number(tr.querySelector('.adjPlus').value||0);
      const net = Math.max(0, r.basePay - r.lateDeduct - minus + plus);
      tr.querySelector('[data-net]').dataset.net = net.toFixed(2);
      tr.querySelector('[data-net]').innerHTML = `<b>${net.toLocaleString(undefined,{maximumFractionDigits:2})}</b>`;
      recomputeTotal();
    };
    tr.querySelector('.adjMinus').oninput = bind;
    tr.querySelector('.adjPlus').oninput  = bind;
    $prBody.appendChild(tr);
  });
  $prStatus.textContent = `‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à ${out.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  recomputeTotal();
}

/* buttons */
$prDraft.onclick = async ()=>{
  try{
    $prDraft.disabled = true; $prDraft.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‚Ä¶';
    await draftCompute($prStart.value, $prEnd.value);
  } finally {
    $prDraft.disabled = false; $prDraft.textContent = '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
  }
};
$prQ.oninput = ()=> draftCompute($prStart.value, $prEnd.value);
document.getElementById('pr-refresh').onclick = ()=> draftCompute($prStart.value, $prEnd.value);
document.getElementById('pr-commit-selected').onclick = async ()=>{
  try{
    normalizePeriod(); savePeriod();
    const btn = document.getElementById('pr-commit-selected');
    btn.disabled = true;
    const jobs = [];
    [...$prBody.querySelectorAll('tr')].forEach((tr,idx)=>{
      const cb = tr.querySelector('input[type="checkbox"]');
      if (!cb || !cb.checked) return;
      const r = __payDraft[idx]; if (!r) return;
      const minus = Number(tr.querySelector('.adjMinus').value||0);
      const plus  = Number(tr.querySelector('.adjPlus').value||0);
      const note  = String(tr.querySelector('.note').value||'');
      const status= 'approved';
      jobs.push({
        lineUserId:  r.lineUserId,
        periodStart: $prStart.value,
        periodEnd:   $prEnd.value,
        status,
        adjustments: { minus, plus, note },
        detail: {
          workDays:   Number(r.workDays||0),
          workHours:  Number(r.workHours||0),
          lateHours:  Number(r.lateHours||0),
          leaveHours:  Number(r.leaveHours||0), 
          basePay:    Number(r.basePay||0),
          lateDeduct: Number(r.lateDeduct||0),
          payType:    String(r.payType||''),
          payRate:    Number(r.payRate||0),
          dailyHours: Number(r.dailyHours||0),
          payEveryN:  Number(r.payEveryN||0)
        }
      });
    });
    if (!jobs.length) { $prMsg.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'; return; }
    await commitPays(jobs, { runId: __editingRunId, overwrite: true });
    $prMsg.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${jobs.length} ‡∏£‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
    __editingRunId = null; __editRunMembers = null; $prRunBox.classList.add('hidden');
    document.getElementById('pr-status').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à ‚Äî ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß';
    document.getElementById('pr-start').disabled = false;
    document.getElementById('pr-end').disabled   = false;
  }catch(e){ $prMsg.textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+(e.message||e); }
  finally{ document.getElementById('pr-commit-selected').disabled = false; }
};
async function commitPays(jobs, opts = {}){
  const res = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/payroll/commit`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      actor: await getActor(),
      jobs,
      notify: true,
      runId: opts.runId || __editingRunId || null,
      overwrite: opts.overwrite === undefined ? true : !!opts.overwrite
    })
  }).catch(()=>null);
  const j = await (res ? res.json().catch(()=>({})) : {});
  if (!res || !res.ok || !j.ok) throw new Error(j.error || 'commit_failed');
  return j;
}

/* ---------- TAB 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---------- */
const $pgGroupsBody = document.getElementById('pg-groups-body');
const $pgCreate = document.getElementById('pg-create');
const $pgEditor = document.getElementById('pg-editor');
const $pgEditTitle = document.getElementById('pg-edit-title');
const $pgName = document.getElementById('pg-name');
const $pgType = document.getElementById('pg-type');
const $pgN    = document.getElementById('pg-n');
const $pgStart= document.getElementById('pg-start');
const $pgMemberQ = document.getElementById('pg-member-q');
const $pgMembers= document.getElementById('pg-members');
const $pgMsg = document.getElementById('pg-msg');
const $pgSave = document.getElementById('pg-save');
const $pgCancel = document.getElementById('pg-cancel');

let __editingGroupId = null;
let __membersDraft = new Set();

function renderCyclesTable(){
  const users = __users || [];
  $pgGroupsBody.innerHTML = (__groups||[]).map((g,idx)=>{
    const ids = __groupMembers[g.groupId] || new Set();
    const memCount = ids.size;
    const typeTxt = (g.type==='monthly') ? '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : `‡∏ó‡∏∏‡∏Å ${g.n||'-'} ‡∏ß‡∏±‡∏ô`;
    return `<tr>
      <td>${idx+1}</td>
      <td>${g.name}</td>
      <td>${typeTxt}</td>
      <td style="text-align:right">${memCount}</td>
      <td><button class="btn-ghost" data-edit="${g.groupId}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
    </tr>`;
  }).join('');

  [...$pgGroupsBody.querySelectorAll('[data-edit]')].forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const gid = btn.dataset.edit;
      await openGroupEditor(gid);
    });
  });
}

function togglePgTypeUI(){
  const t = $pgType.value;
  const showN = (t === 'every_n_days');
  const showPayDay = (t === 'monthly');

  $pgN.closest('.col').style.display     = showN ? '' : 'none';
  $pgStart.closest('.col').style.display = showN ? '' : 'none';
  document.getElementById('pg-payday-wrap').style.display = showPayDay ? '' : 'none';
}

$pgType.addEventListener('change', togglePgTypeUI);

async function openGroupEditor(groupId){
  __editingGroupId = groupId || null;
  $pgMsg.textContent = '';
  const creating = !groupId;
  let meta = { name:'', type:'daily', n: null, startDate: '' };

  if (!creating){
    meta = await fetchGroupDetail(groupId);
  }

  $pgEditTitle.textContent = creating ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà' : `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°: ${meta.name||groupId}`;
  $pgName.value = meta.name || '';
  $pgType.value = meta.type || 'daily';
  $pgN.value = meta.n || '';

  function normYMD(v){
    const s = String(v||'').trim();
    if (!s) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const d = new Date(s);
    if (!isNaN(d)) {
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${d.getFullYear()}-${mm}-${dd}`;
    }
    return '';
   }

  const startRaw = meta.startDate || meta.baseDate || meta.anchorDate || meta.start || '';
  $pgStart.value = normYMD(startRaw);

  const $pgPayDay = document.getElementById('pg-payday');
  $pgPayDay.value = meta.payDayOfMonth || meta.payDay || '';
  const ids = new Set((meta.members||meta.memberIds||[]).map(x=> x.lineUserId || x));
  __membersDraft = ids;

  togglePgTypeUI();
  renderMemberChecklist();

  $pgEditor.classList.remove('hidden');
}

function renderMemberChecklist(){
  const kw = ($pgMemberQ.value||'').trim().toLowerCase();
  const rows = (__users||[])
    .filter(notOwner)
    .filter(u=> !kw || `${u.fullName||''} ${u.jobTitle||''}`.toLowerCase().includes(kw));

  const currentType = ($pgType?.value || '').toLowerCase();

  $pgMembers.innerHTML = rows.map(u=>{
    const checked = __membersDraft.has(u.lineUserId) ? 'checked' : '';
    const cycleTxt = payCycleLabel(u);
    const tCycle = String(u.payCycleType || u.settings?.payCycleType || '').toLowerCase();

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const mismatch = currentType && tCycle && currentType !== 'every_n_days'
      ? (currentType !== tCycle)
      : false;

    const cycleClass = mismatch ? 'err' : 'muted';

    return `<tr>
      <td><input type="checkbox" data-mid value="${u.lineUserId}" ${checked}></td>
      <td>${u.fullName||u.lineUserId}</td>
      <td>${u.jobTitle||'-'}</td>
      <td class="${cycleClass}">${cycleTxt}</td>
    </tr>`;
  }).join('');

  [...$pgMembers.querySelectorAll('[data-mid]')].forEach(ch=>{
    ch.addEventListener('change', ()=>{
      const id = ch.value;
      if (ch.checked) __membersDraft.add(id); else __membersDraft.delete(id);
    });
  });
}
$pgMemberQ.oninput = renderMemberChecklist;

$pgCreate.onclick = ()=> openGroupEditor(null);
$pgCancel.onclick = ()=>{ $pgEditor.classList.add('hidden'); __editingGroupId=null; __membersDraft=new Set(); };

$pgSave.onclick = async ()=>{
  try{
    $pgMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';

    const name = $pgName.value.trim();
    const type = $pgType.value;

    if (!name){ $pgMsg.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°'; return; }
    if (!['daily','monthly','every_n_days'].includes(type)){ 
      $pgMsg.textContent = '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; 
      return; 
    }

    let n = null, startDate = null;
    let payDay = null;

    // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ N / ‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô / ‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢
    if (type === 'daily'){
      n = 1;          // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ GAS/Server ‡πÉ‡∏ä‡πâ n ‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢ ‚Üí ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ß‡∏±‡∏ô
      startDate = null;
      payDay = null;
    }

    // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1‚Äì31 ‡∏´‡∏£‡∏∑‡∏≠ last)
    if (type === 'monthly'){
      const raw = (document.getElementById('pg-payday').value || '').trim().toLowerCase();
      if (raw) {
        if (raw === 'last') {
          payDay = 'last';
        } else {
          const dn = Number.parseInt(raw, 10);
          if (dn >= 1 && dn <= 31) payDay = dn;
          else { $pgMsg.textContent = '‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 1‚Äì31 ‡∏´‡∏£‡∏∑‡∏≠ last'; return; }
        }
      }
      n = null;
      startDate = null;
    }

    // ‡∏£‡∏≤‡∏¢ N ‡∏ß‡∏±‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ N ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô)
    if (type === 'every_n_days'){
      n = Number.parseInt($pgN.value, 10);
      if (!(n >= 1)) { $pgMsg.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å N ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ'; return; }

      const rawStart = ($pgStart.value || '').trim();
      const d = new Date(rawStart);
      const startYMD = (!isNaN(d)) ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` : '';
      if (!startYMD){ $pgMsg.textContent = '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô‡∏ê‡∏≤‡∏ô)'; return; }

      startDate = startYMD;
      payDay = null;
    }

    const payload = {
      actor: await getActor(),
      name,
      type,             // ‡∏™‡πà‡∏á type ‡∏ï‡∏£‡∏á ‡πÜ: daily / monthly / every_n_days
      n,
      startDate,
      payDayOfMonth: payDay,
      payDay: payDay
    };


    const url   = `/api/tenants/${encodeURIComponent(TENANT)}/admin/paygroups${__editingGroupId?('/'+__editingGroupId):''}`;
    const method= __editingGroupId ? 'PUT' : 'POST';
    const r  = await fetch(url, { method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).catch(()=>null);
    const j  = await (r ? r.json().catch(()=>({})) : {});

    if (!r || !r.ok || !j.ok){
      $pgMsg.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (j.error || 'save_group_failed');
      return;
    }

    const gid = __editingGroupId || j.data?.groupId || j.data?.id || j.groupId;
    if (!gid){ $pgMsg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö groupId ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï'; return; }

    const ids = Array.from(__membersDraft || []);
    const r2  = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/paygroups/members`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ actor: await getActor(), groupId: gid, memberIds: ids })
    }).catch(()=>null);
    const j2 = await (r2 ? r2.json().catch(()=>({})) : {});
    if (!r2 || !r2.ok || !j2.ok){
      $pgMsg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ú‡∏π‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (j2.error || 'assign_failed');
      return;
    }

    $pgMsg.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì';
    await loadUsers(true);
    await loadGroups(true);
    $pgEditor.classList.add('hidden');

    setPayrollTab('cycles');
    await primePayroll(true);
    window.scrollTo({ top: 0, behavior: 'smooth' });

  }catch(e){
    $pgMsg.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e);
  }
};


// ==== PAYMENTS TAB ====
const $pyMonth   = document.getElementById('py-month');
const $pyRun     = document.getElementById('py-run');
const $pyQ       = document.getElementById('py-q');
const $pyMsg     = document.getElementById('py-msg');
const $pyAbody   = document.getElementById('py-approved-body');
const $pyPbody   = document.getElementById('py-paid-body');

if ($pyMonth && !$pyMonth.value) $pyMonth.value = todayMonthKey();

// üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö icon ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô /public/static)
const BANK_APPS = {
  kbank: {
    key: 'kbank',
    name: '‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢',
    logo: '/static/‡∏Å‡∏™‡∏¥‡∏Å‡∏£2.png',
    schemeUrl: null, // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ deep link
    appStoreUrl:  'https://apps.apple.com/th/app/k-plus/id361170631',
    playStoreUrl: 'https://play.google.com/store/apps/details?id=com.kasikorn.retail.mbanking.wap'
  },
  scb: {
    key: 'scb',
    name: '‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå',
    logo: '/static/‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå SCB.png',
    schemeUrl: 'scbeasy://login', // ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏Å‡πà‡∏≠‡∏ô
    appStoreUrl:  'https://apps.apple.com/th/app/scb-easy/id568388474',
    playStoreUrl: 'https://play.google.com/store/apps/details?id=com.scb.phone'
  },
  ktb: {
    key: 'ktb',
    name: '‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢',
    logo: '/static/‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢.png',
    schemeUrl: null,
    appStoreUrl:  'https://apps.apple.com/th/app/krungthai-next/id436753378',
    playStoreUrl: 'https://play.google.com/store/apps/details?id=ktbcs.netbank'
  },
  bbl: {
    key: 'bbl',
    name: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û',
    logo: '/static/‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û.png',
    schemeUrl: null,
    appStoreUrl:  'https://apps.apple.com/th/app/bangkok-bank-mobile-banking/id660238716?l=th',
    playStoreUrl: 'https://play.google.com/store/apps/details?id=com.bbl.mobilebanking'
  }
};

function getStoreUrlForDevice(app) {
  const ua = navigator.userAgent || '';
  const isAndroid = /Android/i.test(ua);
  const isIOS    = /iPhone|iPad|iPod/i.test(ua);

  if (isAndroid && app.playStoreUrl) return app.playStoreUrl;
  if (isIOS && app.appStoreUrl)      return app.appStoreUrl;

  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏° ‡∏Ø‡∏•‡∏Ø ‡πÉ‡∏´‡πâ fallback ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ
  return app.appStoreUrl || app.playStoreUrl || null;
}

function openBankApp(app) {
  const storeUrl = getStoreUrlForDevice(app);

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ scheme (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà SCB) ‚Üí ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ fallback ‡πÑ‡∏õ Store
  if (app.schemeUrl && storeUrl) {
    let didHide = false;

    const onVis = () => {
      if (document.hidden) didHide = true;
    };
    document.addEventListener('visibilitychange', onVis);

    setTimeout(() => {
      document.removeEventListener('visibilitychange', onVis);
      if (!didHide) {
        window.location.href = storeUrl;
      }
    }, 1500);

    window.location.href = app.schemeUrl;
  } else if (storeUrl) {
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ scheme ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ‡πÄ‡∏•‡∏¢ (Play ‡∏´‡∏£‡∏∑‡∏≠ App Store ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
    window.location.href = storeUrl;
  }
}



// üîπ element ‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÉ‡∏ô pay-modal
const $payModal    = document.getElementById('pay-modal');
const $paySummary  = document.getElementById('pay-summary');
const $payBankBox  = document.getElementById('pay-bank-box');
const $payCashBox  = document.getElementById('pay-cash-box');
const $payBankLine = document.getElementById('pay-bank-line');
const $payBankApps = document.getElementById('pay-bank-apps');
const $payCopyBtn  = document.getElementById('pay-copy-account');
const $payCopyMsg  = document.getElementById('pay-copy-msg');
const $payMsg      = document.getElementById('pay-msg');
const $payConfirm  = document.getElementById('pay-confirm');

let __payModalRow = null;

function openPayModalDom(){
  if ($payModal) $payModal.classList.remove('hidden');
}
function closePayModal(){
  if ($payModal) $payModal.classList.add('hidden');
  __payModalRow = null;
  if ($payMsg) $payMsg.textContent = '';
  if ($payCopyMsg) $payCopyMsg.textContent = '';
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡∏ö‡∏ô modal
document.getElementById('pay-close')?.addEventListener('click', closePayModal);
document.getElementById('pay-cancel')?.addEventListener('click', closePayModal);
document.querySelector('#pay-modal .backdrop')?.addEventListener('click', closePayModal);

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
async function openPayModal(row){
  if (!$payModal) return;
  __payModalRow = row;

  const titleEl = document.getElementById('pay-title');
  const subEl   = document.getElementById('pay-subtitle');
  if (titleEl) titleEl.textContent = '‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
  if (subEl)   subEl.textContent   = `${row.fullName || '-'} ¬∑ ${row.jobTitle || '-'}`;

  const netStr = Number(row.netPay||0).toLocaleString(undefined,{maximumFractionDigits:2});
  if ($paySummary){
    $paySummary.innerHTML = `
      <div>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <b>${row.fullName || '-'}</b> (${row.jobTitle || '-'})</div>
      <div style="margin-top:4px">
        ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢:
        <span style="font-size:16px;font-weight:700">${netStr}</span> ‡∏ö‡∏≤‡∏ó
      </div>
    `;
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ + ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
  await loadUsers(false);
  const emp = (__users || []).find(u => u.lineUserId === row.lineUserId) || {};
  const payoutChannel = emp.payoutChannel || emp.settings?.payoutChannel || 'cash';
  const bankName      = emp.bankName      || emp.settings?.bankName      || '';
  const bankAccount   = emp.bankAccount   || emp.settings?.bankAccount   || '';

  if (payoutChannel === 'bank' && bankAccount){
    if ($payBankBox) $payBankBox.style.display = '';
    if ($payCashBox) $payCashBox.style.display = 'none';

    if ($payBankLine){
      $payBankLine.innerHTML = `
        <div>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£: <b>${bankName || '-'}</b></div>
        <div>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <b id="pay-account-text">${bankAccount}</b></div>
      `;
    }

    // ‡πÅ‡∏™‡∏î‡∏á icon ‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ 4 ‡∏ï‡∏±‡∏ß
    if ($payBankApps) {
      $payBankApps.innerHTML = Object.values(BANK_APPS).map(app => `
        <button type="button"
                class="bank-app-btn"
                data-bank="${app.key}"
                style="border:none;background:transparent;padding:0;
                      display:flex;flex-direction:column;align-items:center;
                      cursor:pointer">
          <img src="${app.logo}" alt="${app.name}"
              style="width:52px;height:52px;border-radius:16px;object-fit:cover">
          <div style="font-size:11px;color:#64748b;margin-top:4px;text-align:center">
            ${app.name}
          </div>
        </button>
      `).join('');

      $payBankApps.querySelectorAll('.bank-app-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.bank;
          const app = BANK_APPS[key];
          if (!app) return;
          openBankApp(app);
        });
      });
    }


    if ($payCopyBtn){
      $payCopyBtn.style.display = '';
      $payCopyBtn.disabled = false;
    }
  } else {
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‚Üí ‡πÅ‡∏™‡∏î‡∏á "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î"
    if ($payBankBox) $payBankBox.style.display = 'none';
    if ($payCashBox) $payCashBox.style.display = '';
    if ($payCopyBtn){
      $payCopyBtn.style.display = 'none';
      $payCopyBtn.disabled = true;
    }
  }

  openPayModalDom();
}

// ‡∏õ‡∏∏‡πà‡∏° copy ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
$payCopyBtn?.addEventListener('click', async ()=>{
  try{
    const acc = document.getElementById('pay-account-text')?.textContent || '';
    if (!acc){
      if ($payCopyMsg) $payCopyMsg.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
      return;
    }
    if (navigator.clipboard?.writeText){
      await navigator.clipboard.writeText(acc);
      if ($payCopyMsg) $payCopyMsg.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì';
    }else{
      if ($payCopyMsg) $payCopyMsg.textContent = '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
    }
  }catch(e){
    if ($payCopyMsg) $payCopyMsg.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  }
});

// ‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å logic ‡πÄ‡∏î‡∏¥‡∏° markPaidOne ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î modal
$payConfirm?.addEventListener('click', async ()=>{
  if (!__payModalRow) return;
  $payConfirm.disabled = true;
  if ($payMsg) $payMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‚Ä¶';
  await markPaidOne(__payModalRow);   // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ approved ‚Üí paid)
  $payConfirm.disabled = false;
  closePayModal();                    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Tab 3 ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
});


async function primePayments(force=true){
  const runs = await fetchRuns();
  window.__runsById = Object.fromEntries(
    (runs||[]).map(r => [r.runId, { periodStart: r.periodStart, periodEnd: r.periodEnd }])
  );
  const month = $pyMonth.value || todayMonthKey();
  const list = (runs||[]).filter(r => overlapsMonth(r.periodStart, r.periodEnd, month));
  $pyRun.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pay Run ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Äî</option>' + list.map(r=>{
    const label = `${r.runId} ¬∑ ${r.periodStart||'-'} ‚Üí ${r.periodEnd||'-'}`;
    return `<option value="${r.runId}">${label}</option>`;
  }).join('');
  $pyMsg.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pay Run ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  $pyAbody.innerHTML = ''; $pyPbody.innerHTML = '';
}

async function reloadPayments(){
  const runId = $pyRun.value || '';
  const kw = ($pyQ && $pyQ.value ? $pyQ.value : '').trim().toLowerCase();
  if (!runId){ $pyMsg.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Pay Run'; $pyAbody.innerHTML=''; $pyPbody.innerHTML=''; return; }

  const items = await fetchItems({ runId }) || [];
  const rows = items.map(x=>{
    const d   = x.detail||{};
    const net = Number(x.netPay ?? d.netPay
                 ?? (Number(x.basePay ?? d.basePay ?? 0) - Number(x.lateDeduct ?? d.lateDeduct ?? 0)));
    const note = (x.adjustments?.note) || '';
    let status = String(x.status ?? d.status ?? '').toLowerCase();
    if (status !== 'approved' && status !== 'paid') status = 'approved';
    return {
      ...x,
      fullName: x.fullName || x.lineUserId || '-',
      jobTitle: x.jobTitle || '-',
      status,
      netPay: isNaN(net) ? 0 : net,
      note
    };
  }).filter(r => !kw || (`${r.fullName} ${r.jobTitle}`).toLowerCase().includes(kw));

  const approved = rows.filter(r => r.status === 'approved');
  const paid     = rows.filter(r => r.status === 'paid');
  const sel = (window.__runsById||{})[$pyRun.value||''] || {};
  [...approved, ...paid].forEach(r => {
    if (!r.periodStart) r.periodStart = sel.periodStart || '';
    if (!r.periodEnd)   r.periodEnd   = sel.periodEnd   || '';
  });

  $pyAbody.innerHTML = '';
  approved.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${r.fullName}</td>
        <td>${r.jobTitle}</td>
        <td style="text-align:right"><b>${Number(r.netPay||0).toLocaleString(undefined,{maximumFractionDigits:2})}</b></td>
        <td>${(r.note||'')}</td>
        <td>
          <button class="btn" data-pay>‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
        </td>
      `;
    // ‚¨Ö ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà markPaidOne ‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
    tr.querySelector('[data-pay]').onclick = ()=> openPayModal(r);
    $pyAbody.appendChild(tr);
  });

  $pyPbody.innerHTML = '';
  paid.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${r.fullName}</td>
      <td>${r.jobTitle}</td>
      <td style="text-align:right"><b>${Number(r.netPay||0).toLocaleString(undefined,{maximumFractionDigits:2})}</b></td>
      <td>${(r.note||'')}</td>
      <td><a href="#" data-run="${runId}">‡∏î‡∏π‡∏á‡∏ß‡∏î</a></td>
    `;
    tr.querySelector('[data-run]').onclick = (e)=>{ e.preventDefault(); openRunDetail(runId); };
    $pyPbody.appendChild(tr);
  });

  $pyMsg.textContent = `‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢ ${approved.length} ‡∏£‡∏≤‡∏¢ ¬∑ ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${paid.length} ‡∏£‡∏≤‡∏¢`;
}

async function markPaidOne(row){
  try{
    $pyMsg.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${row.fullName}‚Ä¶`;
    const btn = [...document.querySelectorAll('#py-approved-body tr')].find(tr => 
      (tr.children?.[1]?.textContent||'').trim() === (row.fullName||'').trim()
    )?.querySelector('[data-pay]');
    if (btn) btn.disabled = true;

    const d = row.detail || {};
    const runMeta = (window.__runsById||{})[(row.runId || $pyRun.value || '')] || {};
    const ps = row.periodStart || d.periodStart || runMeta.periodStart || '';
    const pe = row.periodEnd   || d.periodEnd   || runMeta.periodEnd   || '';
    const jobs = [{
      lineUserId:  row.lineUserId,
      periodStart: ps,
      periodEnd:   pe,
      status: 'paid',
      adjustments: row.adjustments || {},
      detail: {
        workDays:   Number(row.workDays   ?? d.workDays   ?? 0),
        workHours:  Number(row.workHours  ?? d.workHours  ?? 0),
        lateHours:  Number(row.lateHours  ?? d.lateHours  ?? 0),
        basePay:    Number(row.basePay    ?? d.basePay    ?? 0),
        lateDeduct: Number(row.lateDeduct ?? d.lateDeduct ?? 0),
        payType:    String(row.payType    ?? d.payType    ?? ''),
        payRate:    Number(row.payRate    ?? d.payRate    ?? 0),
        dailyHours: Number(row.dailyHours ?? d.dailyHours ?? 0),
        payEveryN:  Number(row.payEveryN  ?? d.payEveryN  ?? 0)
      }
    }];
    await commitPays(jobs, { 
      runId: row.runId || ($pyRun.value || null),  // ‚úÖ ‡∏ñ‡πâ‡∏≤ row.runId ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ run ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô dropdown
      overwrite: true, 
      notify:false 
    });
    if (btn) { const tr = btn.closest('tr'); if (tr) tr.remove(); }
    $pyMsg.textContent = `‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: ${row.fullName} ‚úì`;
    await reloadPayments();
  }catch(e){
    $pyMsg.textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message||e);
  }
}

$pyMonth?.addEventListener('change', ()=> primePayments(true));
$pyRun?.addEventListener('change', reloadPayments);
$pyQ?.addEventListener('input', reloadPayments);
document.getElementById('py-refresh')?.addEventListener('click', ()=> reloadPayments());

const __origCommitPays = commitPays;
commitPays = async function(jobs, opts={}){
  const res = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/payroll/commit`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      actor: await getActor(),
      jobs,
      notify: opts.notify===undefined ? true : !!opts.notify,
      runId: opts.runId || null,
      overwrite: opts.overwrite === undefined ? true : !!opts.overwrite
    })
  }).catch(()=>null);
  const j = await (res ? res.json().catch(()=>({})) : {});
  if (!res || !res.ok || !j.ok) throw new Error(j.error || 'commit_failed');
  return j;
};


/* ---------- REPORTS (history) ---------- */
const $rpMonth = document.getElementById('rp-month');
const $rpStatus = document.getElementById('rp-status');
const $rpBody = document.getElementById('rp-body');
const $rpTotal = document.getElementById('rp-total');
$rpMonth.value = getMonthKey(FORCED_MONTH) || todayMonthKey();
$rpMonth.onchange = ()=> { loadReportOverview(); loadRunsTable(); };

let __reportRows = [];
let __runsCache = [];

function overlapsMonth(periodStart, periodEnd, yyyyMM){
  const { first, last } = monthRangeStr(yyyyMM);
  const s = new Date(periodStart), e = new Date(periodEnd);
  const f = new Date(first), l = new Date(last);
  if (isNaN(s) || isNaN(e)) return false;
  return !(e < f || s > l);
}

async function loadRunsTable(){
  const month = $rpMonth.value || todayMonthKey();
  const runs = await fetchRuns();
  const list = (runs||[]).filter(r => overlapsMonth(r.periodStart, r.periodEnd, month));

  const $tbody = document.getElementById('runs-body');
  $tbody.innerHTML = '';

  for (const r of list){
    const items = await fetchItems({ runId: r.runId });
    const total = (items||[]).reduce((s,x)=>{
      const net = Number(x.netPay ?? (x.detail?.netPay ?? 0));
      return s + (isNaN(net) ? 0 : net);
    }, 0);
    const n = (items||[]).length;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="#" data-runid="${r.runId}" class="run-link">${r.runId}</a></td>
      <td>${r.periodStart || '-'} ‚Üí ${r.periodEnd || '-'}</td>
      <td style="text-align:right">${n}</td>
      <td style="text-align:right"><b>${total.toLocaleString(undefined,{maximumFractionDigits:2})}</b></td>
      <td>${(r.createdAt||'').replace('T',' ').slice(0,16)}</td>
    `;
    $tbody.appendChild(tr);
  }

  [...document.querySelectorAll('.run-link')].forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const rid = a.dataset.runid || '';
      if (rid) openRunDetail(rid);
    });
  });
}

async function loadReportOverview(){
  const month = $rpMonth.value || todayMonthKey();
  let rows = await fetchItems({ month });

  rows = (rows||[]).map(r => {
    const d = r.detail || {};
    const workDays   = Number(r.workDays ?? d.workDays ?? 0);
    const workHours  = Number(r.workHours ?? d.workHours ?? 0);
    const lateHours  = Number(r.lateHours ?? d.lateHours ?? 0);
    const leaveHours = Number(r.leaveHours ?? d.leaveHours ?? 0);
    const basePay    = Number(r.basePay ?? d.basePay ?? 0);
    const lateDeduct = Number(r.lateDeduct ?? d.lateDeduct ?? 0);
    const netPay     = Number(r.netPay ?? d.netPay ?? (basePay - lateDeduct));
    const payType    = r.payType ?? d.payType ?? '-';
    const payRate    = Number(r.payRate ?? d.payRate ?? 0);
    return { ...r, workDays, workHours, lateHours, basePay, lateDeduct, netPay, payType, payRate };
  });

  $rpBody.innerHTML = '';
  let total = 0;
  rows.forEach(r=>{
    total += Number(r.netPay||0);
    const tr = document.createElement('tr');
    const label = displayPay({
      employmentType: r.detail?.employmentType ?? r.employmentType,
      payType: r.payType,
      payEveryN: r.payEveryN ?? r.detail?.payEveryN
    });
    tr.innerHTML = `
      <td>${r.fullName || r.lineUserId || '-'}</td>
      <td>${r.jobTitle || '-'}</td>
      <td>${label}</td>
      <td style="text-align:right">${Number(r.payRate||0).toLocaleString()}</td>

      <td style="text-align:right">${Number(r.workDays||0)}</td>
      <td style="text-align:right">${Number(r.workHours||0).toFixed(2)}</td>
      <td style="text-align:right">
        ${Number(r.lateHours||0).toFixed(2)} / ${Number(r.leaveHours||0).toFixed(2)}
      </td>

      <td style="text-align:right">${Number(r.basePay||0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td style="text-align:right">${Number(r.lateDeduct||0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td style="text-align:right"><b>${Number(r.netPay||0).toLocaleString(undefined,{maximumFractionDigits:2})}</b></td>
    `;
    $rpBody.appendChild(tr);
  });
  $rpTotal.textContent = total.toLocaleString(undefined,{maximumFractionDigits:2});

  document.getElementById('rp-k1').textContent = $rpTotal.textContent;
  document.getElementById('rp-k2').textContent = String(rows.length);
}

async function fetchRuns(){
  const params = new URLSearchParams({ actorLineUserId:(await getActor()).lineUserId });
  const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/payroll/runs?`+params).catch(()=>null);
  const j = await (r ? r.json().catch(()=>({})) : {});
  return (r && r.ok && j.ok) ? (j.data||[]) : [];
}
async function fetchItems({ runId, month, q }){
  const params = new URLSearchParams({ actorLineUserId:(await getActor()).lineUserId });
  if (runId) params.set('runId', runId);
  if (month) params.set('month', getMonthKey(month));
  if (q) params.set('q', q);
  const r = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/admin/payroll/items?`+params).catch(()=>null);
  const j = await (r ? r.json().catch(()=>({})) : {});
  return (r && r.ok && j.ok) ? (j.data||[]) : [];
}

/* modal */
function showRunModal(){ document.getElementById('run-modal').classList.remove('hidden'); }
function hideRunModal(){ document.getElementById('run-modal').classList.add('hidden'); }
function showDialog(title, text){
  const m = document.getElementById('run-modal');
  m.querySelector('#run-title').textContent = title || '';
  m.querySelector('#run-subtitle').textContent = '';
  m.querySelector('.run-kpi')?.classList.add('hidden');
  m.querySelector('#run-table')?.closest('.table-wrap')?.classList.add('hidden');
  m.querySelector('#run-edit-here')?.closest('.row')?.classList.add('hidden');
  document.getElementById('run-body').innerHTML =
    `<tr><td colspan="9" style="padding:18px 12px; text-align:center; font-weight:700">
       ${text || '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß'}
     </td></tr>`;
  showRunModal();
}
document.getElementById('run-close').onclick = hideRunModal;
document.querySelector('#run-modal .backdrop').onclick = hideRunModal;

let __currentRunMeta = { periodStart:'', periodEnd:'' };
let __afterRoute = null;   // PATCH 3: run after route settled

async function openRunDetail(runId){
  try{
    const mm = document.getElementById('run-modal');
    mm.querySelector('.run-kpi')?.classList.remove('hidden');
    mm.querySelector('#run-table')?.closest('.table-wrap')?.classList.remove('hidden');
    mm.querySelector('#run-edit-here')?.closest('.row')?.classList.remove('hidden');
    document.getElementById('run-body').innerHTML = '';
    
    if (!__runsCache.length) __runsCache = await fetchRuns();
    const meta = __runsCache.find(r=> r.runId===runId) || {};
    const { periodStart, periodEnd } = { periodStart: meta.periodStart||'', periodEnd: meta.periodEnd||'' };
    __currentRunMeta = { periodStart, periodEnd };

    const items = await fetchItems({ runId }) || [];

    const total = items.reduce((s,x)=>{
      const net = Number(x.netPay ?? x.detail?.netPay ?? 0);
      return s + (isNaN(net) ? 0 : net);
    }, 0);
    const n = items.length;
    const avg = n ? total/n : 0;

    document.getElementById('run-title').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ß‡∏î ${runId}`;
    const periodTxt = (periodStart && periodEnd) ? `${periodStart} ‚Üí ${periodEnd}` : '‚Äî';
    document.getElementById('run-subtitle').textContent = `‡∏ä‡πà‡∏ß‡∏á‡∏á‡∏ß‡∏î: ${periodTxt} ¬∑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${n} ‡∏Ñ‡∏ô`;
    document.getElementById('run-k1').textContent = total.toLocaleString(undefined,{maximumFractionDigits:2});
    document.getElementById('run-k2').textContent = String(n);
    document.getElementById('run-k3').textContent = avg.toLocaleString(undefined,{maximumFractionDigits:2});

    const $rb = document.getElementById('run-body'); 
    $rb.innerHTML = '';
    items.forEach((r,idx)=>{
      const workDays   = Number(r.workDays   ?? r.detail?.workDays   ?? 0);
      const workHours  = Number(r.workHours  ?? r.detail?.workHours  ?? 0);
      const lateHours  = Number(r.lateHours  ?? r.detail?.lateHours  ?? 0);
      const leaveHours = Number(r.leaveHours ?? r.detail?.leaveHours ?? 0);
      const basePay    = Number(r.basePay    ?? r.detail?.basePay    ?? 0);
      const lateDeduct = Number(r.lateDeduct ?? r.detail?.lateDeduct ?? 0);
      const netPay     = Number(r.netPay     ?? r.detail?.netPay     ?? (basePay - lateDeduct));
      const payType    = r.payType ?? r.detail?.payType ?? '-';
      const payRate    = Number(r.payRate ?? r.detail?.payRate ?? 0);

      const tr = document.createElement('tr');
      const label = displayPay({
        employmentType: r.detail?.employmentType ?? r.employmentType,
        payType: r.payType ?? r.detail?.payType,
        payEveryN: r.payEveryN ?? r.detail?.payEveryN
      });

      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${r.fullName||r.lineUserId||'-'}</td>
        <td>${label}/${payRate.toLocaleString()}</td>
        <td style="text-align:right">${workDays}</td>
        <td style="text-align:right">${workHours.toFixed(2)}</td>
        <td style="text-align:right">${lateHours.toFixed(2)} / ${leaveHours.toFixed(2)}</td>
        <td style="text-align:right">${basePay.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td style="text-align:right">${lateDeduct.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td style="text-align:right"><b>${netPay.toLocaleString(undefined,{maximumFractionDigits:2})}</b></td>
      `;
      $rb.appendChild(tr);
    });

    document.getElementById('run-edit-here').onclick = async ()=>{
      __editingRunId = runId; 
      __editRunMembers = new Set((items||[]).map(x => x.lineUserId).filter(Boolean));

      document.getElementById('pr-start').value = __currentRunMeta.periodStart || '';
      document.getElementById('pr-end').value   = __currentRunMeta.periodEnd   || '';
      document.getElementById('pr-start').disabled = true;
      document.getElementById('pr-end').disabled   = true;

      __afterRoute = async ()=>{
        setPayrollTab('payrun');
        renderEditRunChips();
        await draftCompute($prStart.value, $prEnd.value);
        $prStatus.textContent =
          `‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏¥‡∏°: ${__editingRunId} ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ó‡∏±‡∏ö‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ)`;
      };

      location.hash = '#payroll';
      hideRunModal();
    };

    showRunModal();
  }catch(e){
    alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e));
  }
}

/* ---------- preload overlay ---------- */
function showPreloader(msg){
  const el = document.getElementById('app-preload');
  el.classList.remove('hidden');
  if (msg) el.querySelector('.muted').textContent = msg;
}
function hidePreloader(){
  document.getElementById('app-preload').classList.add('hidden');
}

/* ---------- boot & route (fast-first-paint) ---------- */
async function primeUsers(force=true){ document.getElementById('lazyNote').textContent='‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶'; await loadUsers(!!force); renderCards(__users); }
async function primeLogs(force=true){ document.getElementById('lazyNote2').textContent='‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Ä¶'; await loadUsers(!!force); renderUserStripLogs(); if (!CURRENT_USER && __users.length) openLogs(__users[0]); }
async function primePayroll(force=true){ await loadUsers(!!force); await loadGroups(true); $prStatus.textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Äù'; }
async function primeReports(force=true){
  await loadUsers(!!force);
  await loadReportOverview();
  await loadRunsTable();
  document.getElementById('rp-status').textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
}

/* ====== PATCH 2: serialize routing & skip same view ====== */
let __routeBusy = false;
let __currentView = '';

async function applyRoute(){
  if (__routeBusy) return;
  __routeBusy = true;
  try{
    const h=(location.hash||'').replace('#','').trim().toLowerCase();
    const v=h||DEFAULT_VIEW||'menu';

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï view ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    __currentView = v;

    // ‡πÅ‡∏™‡∏î‡∏á section ‡∏ï‡∏≤‡∏° view
    show(v);

    // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° view
    if (v==='users')   await primeUsers(true);
    if (v==='logs')    await primeLogs(true);
    if (v==='reports') await primeReports(true);

    if (v==='payroll'){ 
      show('payroll');
      setPayrollTab('payrun');
      await primePayroll(true);
    }
    if (v==='payments'){ 
      show('payroll');
      setPayrollTab('payments');
      await primePayments(true);
    }
  } finally {
    __routeBusy = false;
  }
}


window.addEventListener('hashchange', async ()=>{
  showPreloader('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‚Ä¶');
  try{
    await applyRoute();
    if (typeof __afterRoute === 'function') {
      const fn = __afterRoute;
      __afterRoute = null;
      await fn();
    }
  } finally { hidePreloader(); }
});

document.getElementById('btnHome').addEventListener('click', e=>{ e.preventDefault(); go('menu'); });

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ month inputs ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM ‡πÄ‡∏™‡∏°‡∏≠
document.addEventListener('DOMContentLoaded', ()=>{
  const m1 = document.getElementById('month'); if (m1 && !m1.value) m1.value = todayMonthKey();
  const m2 = document.getElementById('rp-month'); if (m2 && !m2.value) m2.value = todayMonthKey();
});

if (window.__TA_INITED__) {
  console.log('[TA] skip duplicate boot');
} else {
  window.__TA_INITED__ = true;

  (async ()=>{
    try{
      if (!TENANT) throw new Error('URL ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå tenant');

      const firstView=(location.hash||'').slice(1)||DEFAULT_VIEW||'menu';
      show(firstView.toLowerCase());
      showPreloader('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î LIFF ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶');
      setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF‚Ä¶');

      const ok = await ensureLiff(); if (!ok) return;
      await getActor();
      setMsg('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','ok');

      await applyRoute();

      document.getElementById('reload').onclick = async()=> renderCards(await loadUsers(true));
      document.getElementById('q').oninput      = async()=> renderCards(await loadUsers());

      document.getElementById('users-refresh').onclick   = ()=> primeUsers(true);
      document.getElementById('logs-refresh').onclick    = ()=> primeLogs(true);
      document.getElementById('pr-hard-reload').onclick  = async ()=>{
        $prMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Ä¶';
        await primePayroll(true);
        document.getElementById('pr-body').innerHTML = '';
        document.getElementById('pr-total').textContent = '0.00';
        $prMsg.textContent = '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß';
      };
      document.getElementById('reports-refresh').onclick = ()=> primeReports(true);

      if (MODE_PAYROLL){ location.hash = '#payroll'; await applyRoute(); }
      if (MODE_REPORT){  location.hash = '#reports'; await applyRoute(); }
    }catch(e){
      setMsg('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+ (e.message||e), 'err');
    } finally {
      hidePreloader();
    }
  })();
}
</script>
</body>
</html>
