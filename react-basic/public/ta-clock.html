<!-- /public/ta-clock.html -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</title>
  <style>
    :root{
      --ok:#16a34a;     /* ‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ */
      --out:#ef4444;    /* ‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å */
      --fg:#111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f8fafc;
      --card:#fff;
      --shadow: 0 10px 25px rgba(2,6,23,.08), 0 4px 8px rgba(2,6,23,.06);
      --accent: var(--ok); /* ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô --out ‡πÄ‡∏°‡∏∑‡πà‡∏≠ type=out */
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --bg:#0b1220; --card:#0f172a; --shadow:none; }
      body{ background:#0b1220; }
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:24px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      color:var(--fg); background:var(--bg);
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      width:min(640px,100%); background:var(--card);
      border:1px solid var(--line); border-radius:16px;
      box-shadow:var(--shadow); overflow:hidden;
    }
    .head{
      display:flex; align-items:center; gap:12px;
      padding:18px 20px; color:#fff;
      background: linear-gradient(180deg,rgba(255,255,255,.0),rgba(255,255,255,.0)), var(--accent);
    }
    .head .icon{
      width:42px; height:42px; border-radius:12px;
      background: rgba(255,255,255,.15);
      display:grid; place-items:center; font-size:22px;
    }
    .title{ font-size:20px; font-weight:700; line-height:1.2 }
    .sub{ opacity:.95; font-size:13px }

    .body{ padding:18px 20px; display:grid; gap:14px }
    .progress{ width:100%; height:8px; background:var(--line); border-radius:999px; overflow:hidden }
    .bar{ height:100%; width:0%; background:var(--accent); transition:width .6s ease }

    .who{ font-size:20px; font-weight:800 }
    .muted{ color:var(--muted); font-size:13px }
    .ok{ color:#22c55e; font-weight:700 }
    .err{ color:#f43f5e; font-weight:700 }

    .pill{
      display:inline-block; font-size:12px; font-weight:700; letter-spacing:.3px;
      padding:6px 10px; border-radius:999px; color:#fff; background:var(--accent);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{
      flex:1 1 auto; min-width:120px;
      padding:12px 16px; border:0; border-radius:12px;
      background:#1d4ed8; color:#fff; font-size:16px; font-weight:700;
      box-shadow:0 6px 14px rgba(30,64,175,.25); cursor:pointer;
    }
    .btn.secondary{ background:#0f172a }
    .btn[disabled]{ background:#94a3b8; box-shadow:none; cursor:not-allowed }
    .hint{
      background:#fff7ed; color:#9a3412; border:1px solid #fed7aa;
      padding:10px 12px; border-radius:12px; font-size:13px; display:none;
    }
    footer{ padding:10px 16px; border-top:1px solid var(--line); font-size:12px; color:var(--muted); text-align:center }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/__boot/liff-id.js"></script>
</head>
<body>
  <main class="card">
    <header class="head" id="hero">
      <div class="icon" id="heroIcon">‚è±Ô∏è</div>
      <div>
        <div class="title" id="title">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="sub" id="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‚Ä¶</div>
      </div>
    </header>

    <section class="body">
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div class="who" id="who">‚Äî</div>
      <div class="muted" id="when">‚Äî</div>

      <div id="status" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>

      <div class="row" id="actions" style="display:none">
        <button id="retry" class="btn">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
        <button id="close" class="btn secondary">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
      </div>

      <div id="geoHelp" class="hint">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Location) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á<br/>
        <b>iPhone:</b> Settings ‚Üí Privacy &amp; Security ‚Üí Location Services ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ LINE ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <i>While Using</i> ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î <i>Precise Location</i>)<br/>
        <b>Android:</b> Settings ‚Üí Apps ‚Üí LINE ‚Üí Permissions ‚Üí Location ‚Üí Allow while using
      </div>
    </section>

    <footer>SUPER HR ‚Ä¢ Time Attendance</footer>
  </main>

<script>
(function () {
  // ---------- helpers ----------
  const $ = (s)=>document.querySelector(s);
  const $bar = $('#bar');
  const $status = $('#status');
  const $title = $('#title');
  const $sub = $('#subtitle');
  const $icon = $('#heroIcon');
  const $hero = $('#hero');
  const $who = $('#who');
  const $when = $('#when');
  const $retry = $('#retry');
  const $close = $('#close');
  const $actions = $('#actions');
  const $geoHelp = $('#geoHelp');

  function setAccent(hex){
    document.documentElement.style.setProperty('--accent', hex);
    $hero.style.background = `linear-gradient(180deg, rgba(255,255,255,.0), rgba(255,255,255,.0)), ${hex}`;
  }
  function setProgress(p){ $bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
  function setStatus(text, cls){ $status.className = cls || 'muted'; $status.textContent = text; }
  function fmtNow(){
    const d = new Date();
    return d.toLocaleString('th-TH', { dateStyle:'full', timeStyle:'short' });
  }
  function showActions(show){ $actions.style.display = show ? 'flex' : 'none'; }

  // ---------- merge query + liff.state ----------
  function readParams() {
    const outer = new URLSearchParams(location.search);
    let merged = new URLSearchParams(outer);
    const st = outer.get('liff.state');
    if (st) {
      const inner = new URLSearchParams(st.startsWith('?') ? st.slice(1) : st);
      for (const [k, v] of inner.entries()) merged.set(k, v);
    }
    return merged;
  }

  const qs = readParams();
  const LIFF_ID = qs.get('liffId') || (window.DEFAULT_LIFF_ID || '');
  const TENANT  = qs.get('tenant') || '';
  const TYPE    = (qs.get('type') || 'in').toLowerCase(); // in|out

  // Header theme
  if (TYPE === 'in'){ $title.textContent = '‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤'; $icon.textContent = 'üü¢'; setAccent('#16a34a'); }
  else { $title.textContent = '‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'; $icon.textContent = 'üî¥'; setAccent('#ef4444'); }

  // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏ï‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
  $when.textContent = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + fmtNow();

  async function ensureLiff() {
    if (!LIFF_ID) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF ID');
    setProgress(15);
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° LIFF‚Ä¶');
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      $sub.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶';
      liff.login({ redirectUri: location.href });
      return false; // ‡∏à‡∏∞ redirect ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
    }
    return true;
  }

  function getUid() {
    const idt = liff.getDecodedIDToken();
    return (idt && idt.sub) ? idt.sub.replace('line:', '') : null;
  }

  async function fetchFullName(uid){
    try{
      const res = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/attendance/profile?lineUserId=${encodeURIComponent(uid)}`);
      const j = await res.json().catch(()=> ({}));
      return (j && j.ok && j.data && j.data.fullName) ? String(j.data.fullName) : '';
    }catch{ return ''; }
  }

  function explainGeoError(err){
    const code = err && (err.code ?? 0);
    if (code === 1) return { msg:'‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Location ‡πÉ‡∏´‡πâ LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)', showHelp:true };
    if (code === 2) return { msg:'‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î GPS/‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)', showHelp:false };
    if (code === 3) return { msg:'‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)', showHelp:false };
    return { msg:(err && err.message) ? String(err.message) : '‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', showHelp:false };
  }

  function getGeoAndSend(uid) {
    if (!navigator.geolocation) throw new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');

    setProgress(55);
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‚Ä¶');
    navigator.geolocation.getCurrentPosition(async (pos) => {
      try {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        setProgress(75);
        setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶');

        const res = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/attendance/clock`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lineUserId: uid, type: TYPE, lat, lng })
        });
        const j = await res.json().catch(()=> ({}));
        if (!res.ok || !j.ok) throw new Error(j.error || 'clock_failed');

        setProgress(100);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'ok');
        $sub.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
        $when.textContent = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + fmtNow();

        // ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô LINE)
        try { if (liff.isInClient()) setTimeout(()=> liff.closeWindow(), 3000); } catch {}
      } catch (e) {
        setProgress(100);
        setStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e), 'err');
        showActions(true);
      }
    }, (err) => {
      const info = explainGeoError(err);
      setProgress(100);
      setStatus(info.msg, 'err');
      $geoHelp.style.display = info.showHelp ? 'block' : 'none';
      showActions(true);
    }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
  }

  async function boot() {
    try {
      setProgress(8);
      $sub.textContent = TYPE === 'in' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‚Ä¶' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‚Ä¶';
      $who.innerHTML = '<span class="pill">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';

      showActions(false);
      $geoHelp.style.display = 'none';

      const ok = await ensureLiff();
      if (ok === false) return; // login redirect

      setProgress(30);
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‚Ä¶');
      const uid = getUid();
      if (!uid) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô LINE UserId ‡πÑ‡∏î‡πâ');
      if (!TENANT) throw new Error('URL ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå tenant');

      // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (fullName) + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ ‚Ä¶"
      const fullName = (await fetchFullName(uid)) || '';
      const actText = (TYPE === 'in') ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å';
      $who.textContent = (fullName ? `${fullName} ` : '') + actText;
      $when.textContent = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + fmtNow();

      getGeoAndSend(uid);
    } catch (e) {
      setProgress(100);
      setStatus('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message || e), 'err');
      showActions(true);
    }
  }

  $retry.addEventListener('click', () => { boot(); });
  $close.addEventListener('click', () => {
    try { if (liff.isInClient()) liff.closeWindow(); else window.close(); } catch { window.close(); }
  });

  boot();
})();
</script>
</body>
</html>
