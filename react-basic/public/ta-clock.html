<!-- /public/ta-clock.html -->
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</title>
  <style>
    :root{
      --ok:#16a34a;          /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ */
      --out:#ef4444;         /* ‡πÅ‡∏î‡∏á‡∏≠‡∏≠‡∏Å */
      --fg:#111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f8fafc;
      --card:#fff;
      --shadow: 0 10px 25px rgba(2,6,23,.08), 0 4px 8px rgba(2,6,23,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{ --fg:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --bg:#0b1220; --card:#0f172a; --shadow:none; }
      body{ background: #0b1220; }
    }
    *{ box-sizing: border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      color:var(--fg); background:var(--bg);
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      width:min(640px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      display:flex; align-items:center; gap:12px;
      padding:18px 20px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.0), rgba(255,255,255,.0)),
        var(--accent);
      color:#fff;
    }
    .head .icon{
      width:42px; height:42px; border-radius:12px;
      background: rgba(255,255,255,.15);
      display:grid; place-items:center; font-size:22px;
    }
    .title{ font-size:20px; font-weight:700; line-height:1.2 }
    .sub{ opacity:.9; font-size:13px }

    .body{ padding:18px 20px; display:grid; gap:14px }
    .progress{ width:100%; height:8px; background:var(--line); border-radius:999px; overflow:hidden }
    .bar{ height:100%; width:0%; background:#fff; opacity:.9; }

    .steps{ display:grid; gap:10px }
    .step{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 12px; border:1px dashed var(--line); border-radius:12px;
    }
    .step .dot{
      width:10px; height:10px; border-radius:999px; margin-top:6px; background:var(--line);
    }
    .step.active{ border-style:solid }
    .step.active .dot{ background:#fff; outline:3px solid rgba(255,255,255,.5) }
    .step.done  .dot{ background:#22c55e }
    .step .t{ font-weight:600; font-size:14px }
    .step .d{ font-size:13px; color:var(--muted) }

    .muted{ color:var(--muted); font-size:13px }
    .err{ color:#f43f5e; font-weight:600 }
    .ok{ color:#22c55e; font-weight:600 }

    .row{ display:flex; gap:8px; flex-wrap:wrap }
    .btn{
      flex:1 1 auto;
      padding:12px 16px; border:0; border-radius:12px;
      background:#1d4ed8; color:#fff; font-size:16px; font-weight:600;
      box-shadow: 0 6px 14px rgba(30,64,175,.25);
    }
    .btn[disabled]{ background:#94a3b8; box-shadow:none }
    .hint{
      background:#fff7ed; color:#9a3412; border:1px solid #fed7aa;
      padding:10px 12px; border-radius:12px; font-size:13px; display:none;
    }

    .spinner{
      width:18px; height:18px; border:3px solid rgba(255,255,255,.35);
      border-top-color:#fff; border-radius:50%; display:inline-block;
      animation:spin 1s linear infinite; vertical-align:-3px; margin-right:6px;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    footer{ padding:10px 16px; border-top:1px solid var(--line); font-size:12px; color:var(--muted); text-align:center }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/__boot/liff-id.js"></script>
</head>
<body>
  <main class="card">
    <header class="head" id="hero">
      <div class="icon" id="heroIcon">‚è±Ô∏è</div>
      <div>
        <div class="title" id="title">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="sub" id="subtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>
      </div>
    </header>

    <section class="body">
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div class="steps" id="steps">
        <div class="step active" data-step="1">
          <div class="dot"></div>
          <div>
            <div class="t">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF</div>
            <div class="d">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
          </div>
        </div>
        <div class="step" data-step="2">
          <div class="dot"></div>
          <div>
            <div class="t">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</div>
            <div class="d">‡∏≠‡πà‡∏≤‡∏ô LINE User ID</div>
          </div>
        </div>
        <div class="step" data-step="3">
          <div class="dot"></div>
          <div>
            <div class="t">‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>
            <div class="d">‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
          </div>
        </div>
        <div class="step" data-step="4">
          <div class="dot"></div>
          <div>
            <div class="t">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
            <div class="d">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö</div>
          </div>
        </div>
      </div>

      <div id="status" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>

      <div class="row">
        <button id="retry" class="btn" style="display:none">
          <span class="spinner" aria-hidden="true"></span>‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>

      <div id="geoHelp" class="hint">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Location) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ iPhone: Settings ‚Üí Privacy &amp; Security ‚Üí Location Services ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ LINE ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      </div>
    </section>

    <footer>SUPER HR ‚Ä¢ Time Attendance</footer>
  </main>

<script>
(function () {
  // ---------- UI helpers ----------
  const $ = (s)=>document.querySelector(s);
  const steps = Array.from(document.querySelectorAll('.step'));
  const $bar = $('#bar');
  const $status = $('#status');
  const $retry = $('#retry');
  const $title = $('#title');
  const $sub = $('#subtitle');
  const $hero = $('#hero');
  const $icon = $('#heroIcon');
  const $geoHelp = $('#geoHelp');

  function setAccent(hex){
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å
    $hero.style.setProperty('--accent', hex);
    $hero.style.background = `linear-gradient(180deg, rgba(255,255,255,.0), rgba(255,255,255,.0)), ${hex}`;
  }
  function setStep(n, msg, cls){
    steps.forEach((el,i)=>{
      el.classList.toggle('active', i===n-1);
      if(i < n-1) el.classList.add('done');
    });
    $bar.style.width = (n-1)*33 + '%';
    if(msg){ $status.className = cls || 'muted'; $status.textContent = msg; }
  }
  function showRetry(show, isGeoErr){
    $retry.style.display = show ? 'inline-block':'none';
    $geoHelp.style.display = (show && isGeoErr) ? 'block':'none';
  }

  // ---------- merge query + liff.state ----------
  function readParams() {
    const outer = new URLSearchParams(location.search);
    let merged = new URLSearchParams(outer);
    const st = outer.get('liff.state');
    if (st) {
      const inner = new URLSearchParams(st.startsWith('?') ? st.slice(1) : st);
      for (const [k, v] of inner.entries()) merged.set(k, v);
    }
    return merged;
  }

  const qs = readParams();
  const LIFF_ID = qs.get('liffId') || (window.DEFAULT_LIFF_ID || '');
  const TENANT  = qs.get('tenant') || '';
  const TYPE    = (qs.get('type') || 'in').toLowerCase(); // in|out

  // header icon + color
  if (TYPE === 'in'){ $title.textContent = '‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤'; $icon.textContent = 'üü¢'; setAccent('#16a34a'); }
  else { $title.textContent = '‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'; $icon.textContent = 'üî¥'; setAccent('#ef4444'); }

  async function ensureLiff() {
    if (!LIFF_ID) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF ID');
    setStep(1, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF‚Ä¶');
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      $sub.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶';
      liff.login({ redirectUri: location.href });
      return false; // ‡∏à‡∏∞‡∏£‡∏µ‡πÑ‡∏î‡πÄ‡∏£‡∏Å‡∏ï‡πå‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
    }
    return true;
  }

  function getUid() {
    const idt = liff.getDecodedIDToken();
    return (idt && idt.sub) ? idt.sub.replace('line:', '') : null;
  }

  function getGeoAndSend(uid) {
    if (!navigator.geolocation) throw new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');

    setStep(3, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‚Ä¶');
    navigator.geolocation.getCurrentPosition(async (pos) => {
      try {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        setStep(4, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶');
        const res = await fetch(`/api/tenants/${encodeURIComponent(TENANT)}/attendance/clock`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lineUserId: uid, type: TYPE, lat, lng })
        });

        const j = await res.json().catch(()=> ({}));
        if (!res.ok || !j.ok) throw new Error(j.error || 'clock_failed');

        setStep(4, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'ok');
        $sub.textContent = '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
        try { if (liff.isInClient()) setTimeout(()=> liff.closeWindow(), 900); } catch {}
      } catch (e) {
        setStep(4, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e), 'err');
        showRetry(true, false);
      }
    }, (err) => {
      setStep(3, '‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || err), 'err');
      showRetry(true, true);
    }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
  }

  async function boot() {
    try {
      $sub.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶';
      showRetry(false, false);
      setStep(1);

      const ok = await ensureLiff();
      if (ok === false) return; // login redirect

      setStep(2, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‚Ä¶');
      const uid = getUid();
      if (!uid) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô LINE UserId ‡πÑ‡∏î‡πâ');

      if (!TENANT) throw new Error('URL ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå tenant');

      getGeoAndSend(uid);
    } catch (e) {
      setStep(1, '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message || e), 'err');
      showRetry(true, false);
    }
  }

  $retry.addEventListener('click', () => { showRetry(false,false); boot(); });
  boot();
})();
</script>
</body>
</html>
